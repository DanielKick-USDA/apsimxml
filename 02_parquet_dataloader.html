<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>apsimxml</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="apsimxml">
<meta property="og:description" content="Calibration of ApsimX models using machine learning methods.">
<meta property="og:site_name" content="apsimxml">
<meta name="twitter:title" content="apsimxml">
<meta name="twitter:description" content="Calibration of ApsimX models using machine learning methods.">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">apsimxml</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./02_parquet_dataloader.html">Masking genotypes</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">apsimxml</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./core.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">core</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_sql_to_parquet.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">01_sql_to_parquet.html</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_parquet_dataloader.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Masking genotypes</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#masking-genotypes" id="toc-masking-genotypes" class="nav-link active" data-scroll-target="#masking-genotypes">Masking genotypes</a></li>
  <li><a href="#loading-results-tables" id="toc-loading-results-tables" class="nav-link" data-scroll-target="#loading-results-tables">Loading Results tables</a></li>
  <li><a href="#masking-genotypes-1" id="toc-masking-genotypes-1" class="nav-link" data-scroll-target="#masking-genotypes-1">Masking genotypes</a></li>
  <li><a href="#loading-results-tables-1" id="toc-loading-results-tables-1" class="nav-link" data-scroll-target="#loading-results-tables-1">Loading Results tables</a></li>
  <li><a href="#remove-run-on-simulation-results-and-return-each-years-results" id="toc-remove-run-on-simulation-results-and-return-each-years-results" class="nav-link" data-scroll-target="#remove-run-on-simulation-results-and-return-each-years-results">Remove run-on simulation results and return each year’s results</a></li>
  <li><a href="#clean-up-environmental-data" id="toc-clean-up-environmental-data" class="nav-link" data-scroll-target="#clean-up-environmental-data">Clean up Environmental Data</a>
  <ul class="collapse">
  <li><a href="#physical-properties" id="toc-physical-properties" class="nav-link" data-scroll-target="#physical-properties">Physical Properties</a></li>
  </ul></li>
  <li><a href="#define-working-set" id="toc-define-working-set" class="nav-link" data-scroll-target="#define-working-set">Define working set</a></li>
  <li><a href="#convert-small-datasets-to-tensors" id="toc-convert-small-datasets-to-tensors" class="nav-link" data-scroll-target="#convert-small-datasets-to-tensors">Convert Small Datasets to Tensors</a>
  <ul class="collapse">
  <li><a href="#genotypes-cultivar-variables" id="toc-genotypes-cultivar-variables" class="nav-link" data-scroll-target="#genotypes-cultivar-variables"><code>Genotypes</code> (Cultivar variables)</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/DanielKick-USDA/apsimxml/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">




<div id="cell-0" class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> einops</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> DataLoader</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyarrow <span class="im">as</span> pa</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyarrow.parquet <span class="im">as</span> pq</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<div id="cell-2" class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute unix epoch to date table</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _prep_unix_epoch_to_date(max_year <span class="op">=</span> <span class="dv">2025</span>):</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    month_abbr <span class="op">=</span> [<span class="st">'Jan'</span>, <span class="st">'Feb'</span>, <span class="st">'Mar'</span>, <span class="st">'Apr'</span>, <span class="st">'May'</span>, <span class="st">'Jun'</span>, <span class="st">'Jul'</span>, <span class="st">'Aug'</span>, <span class="st">'Sep'</span>, <span class="st">'Oct'</span>, <span class="st">'Nov'</span>, <span class="st">'Dec'</span>]</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    max_day <span class="op">=</span> (datetime.datetime(max_year, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>) <span class="op">-</span> datetime.datetime(<span class="dv">1970</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>)).days </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    unix_epoch <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(max_day)]</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    date_times <span class="op">=</span> [datetime.datetime(<span class="dv">1970</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>) <span class="op">+</span> datetime.timedelta(i) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(max_day)]</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> as_SowDate(date_time):</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        day <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>date_time<span class="sc">.</span>day<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(day) <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span>(<span class="ss">f'0</span><span class="sc">{</span>day<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>month_abbr[date_time.month <span class="op">-</span> <span class="dv">1</span>]<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span>(<span class="ss">f'</span><span class="sc">{</span>day<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>month_abbr[date_time.month <span class="op">-</span> <span class="dv">1</span>]<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    tmp <span class="op">=</span> pd.DataFrame({</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Unix'</span>: unix_epoch,</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Year'</span>:[e.year <span class="cf">for</span> e <span class="kw">in</span> date_times],</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Month'</span>:[e.month <span class="cf">for</span> e <span class="kw">in</span> date_times],</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Day'</span>:[e.day <span class="cf">for</span> e <span class="kw">in</span> date_times],</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">'SowDate'</span>:[as_SowDate(date_time <span class="op">=</span> e) <span class="cf">for</span> e <span class="kw">in</span> date_times]</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    _ <span class="op">=</span> tmp.loc[:, [<span class="st">'Unix'</span>, <span class="st">'Year'</span>]].groupby([<span class="st">'Year'</span>]).<span class="bu">min</span>().reset_index().rename(columns<span class="op">=</span>{<span class="st">'Unix'</span>:<span class="st">'MinUnix'</span>})</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    tmp <span class="op">=</span> tmp.merge(_)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    tmp[<span class="st">'DOY'</span>] <span class="op">=</span> tmp[<span class="st">'Unix'</span>] <span class="op">-</span> tmp[<span class="st">'MinUnix'</span>]</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    tmp <span class="op">=</span> tmp.drop(columns <span class="op">=</span> [<span class="st">'MinUnix'</span>])</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tmp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-3" class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># how bad would it be if we stored a bunch of tiny parquet files? </span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># saving many tiny parquet files will increase storage cost by 1.6x</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># That's not great but not horrible either. We're talking about approximately 500 gb.</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># (305213583096*1.6)/1000000000</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 488.34</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># apsimx_sim_parquet_dir = '/home/Shared/cultivar_sim_exps'</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Result = pq.read_table(apsimx_sim_parquet_dir+'/'+'sim_1698440407_4739.parquet').to_pandas()</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># -rw-rw-r-- 1 kickd newgroup 2939581425 Jun  1 01:08 cultivar_sim_exps/sim_1698440407_4739.parquet</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># for i in tqdm(Result.FactorialUID.unique()):</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co">#     table = Result.loc[(Result.FactorialUID == i), ].drop(columns = 'FactorialUID')</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co">#     table = pa.Table.from_pandas(table)</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co">#     pq.write_table(table, f'/home/Shared/testing_rm_after0620/{i}.parquet')</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 100%|██████████| 24025/24025 [33:58&lt;00:00, 11.79it/s]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-4" class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The goal is to have a (postgres?) SQL db that we can query. To not have a delay we're going to instead load a batch into memory BUT allow for redefining this batch by swapping out the dataloader.</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Workflow:</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the desired data </span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the main tables to figure out what parquet files we need to pull from.</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Pull all the data in and represent as tensors</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-5" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>apsimx_sim_parquet_dir <span class="op">=</span> <span class="st">'/home/Shared/cultivar_sim_exps'</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>os.listdir(apsimx_sim_parquet_dir)[<span class="dv">0</span>:<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>['sim_1698440407_4739.parquet',
 'sim_1697418008_10643.parquet',
 'sim_1697187607_79518.parquet']</code></pre>
</div>
</div>
<div id="cell-6" class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>[e <span class="cf">for</span> e <span class="kw">in</span> os.listdir(apsimx_sim_parquet_dir) <span class="cf">if</span> e[<span class="dv">0</span>:<span class="dv">4</span>] <span class="op">!=</span> <span class="st">'sim_'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>['DefaultCultivarsAll.parquet', 'Genotypes.parquet', 'Ids.parquet']</code></pre>
</div>
</div>
<div id="cell-7" class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># metadata </span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>DefaultCultivarsAll <span class="op">=</span> pq.read_table(apsimx_sim_parquet_dir<span class="op">+</span><span class="st">'/'</span><span class="op">+</span><span class="st">'DefaultCultivarsAll.parquet'</span>).to_pandas()</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>Genotypes           <span class="op">=</span> pq.read_table(apsimx_sim_parquet_dir<span class="op">+</span><span class="st">'/'</span><span class="op">+</span><span class="st">'Genotypes.parquet'</span>).to_pandas()</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>Ids                 <span class="op">=</span> pq.read_table(apsimx_sim_parquet_dir<span class="op">+</span><span class="st">'/'</span><span class="op">+</span><span class="st">'Ids.parquet'</span>).to_pandas()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-9" class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># I'm setting up a class to help find the files we need to read through to build the datset </span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This works by holding a copy of the Ids and Genotypes tables. </span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># We'll operate on those, filtering them down until the tables only contain the enries we want to use.</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Next we'll use a that produces tuples of the (parquet file, filtering criteria)</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> data_helper():</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, genotypes_path, ids_path, results_path, ssurgo_path, met_path):</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># used later to get the results. Append / if there isn't one.</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> results_path[<span class="op">-</span><span class="dv">1</span>] <span class="op">!=</span> <span class="st">'/'</span>: </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>            results_path <span class="op">=</span> results_path<span class="op">+</span><span class="st">'/'</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.results_path <span class="op">=</span> results_path</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        Genotypes <span class="op">=</span> pq.read_table(genotypes_path).to_pandas()</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># coerce None to NaN (default cultivars don't have all values specified)</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> e <span class="kw">in</span> [ee <span class="cf">for</span> ee <span class="kw">in</span> <span class="bu">list</span>(Genotypes) <span class="cf">if</span> ee <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'File'</span>, <span class="st">'Genotype'</span>]]:</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>            Genotypes[e] <span class="op">=</span> Genotypes[e].astype(<span class="bu">float</span>)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> (Genotypes.isna().<span class="bu">sum</span>(axis <span class="op">=</span> <span class="dv">1</span>) <span class="op">==</span> <span class="dv">0</span>)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.Genotypes <span class="op">=</span> Genotypes.loc[mask, ].reset_index(drop <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.Ids <span class="op">=</span> pq.read_table(ids_path).to_pandas()</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Environmental data</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ssurgo_data <span class="op">=</span> pq.read_table(ssurgo_path</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>                            ).to_pandas(</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>                            ).rename(columns <span class="op">=</span> {<span class="st">'soil_i'</span>:<span class="st">'SoilIdx'</span>})</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.met_data    <span class="op">=</span> pq.read_table(met_path</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>                            ).to_pandas(</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>                            ).rename(columns <span class="op">=</span> {<span class="st">'latitude'</span>:  <span class="st">'Latitude'</span>,</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">'longitude'</span>: <span class="st">'Longitude'</span>})</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> apply_mask(<span class="va">self</span>, table, mask):</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">"This method takes care of automatically filtering the non-masked table."</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> table <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'Genotypes'</span>, <span class="st">'Ids'</span>]:</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'table should be Genotypes or Ids'</span>)   </span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> table <span class="op">==</span> <span class="st">'Genotypes'</span>:</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>                <span class="co"># apply mask to filter the table</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.Genotypes <span class="op">=</span> <span class="va">self</span>.Genotypes.loc[mask, ].reset_index(drop <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>                <span class="co"># left join to update the other table</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.Ids <span class="op">=</span> <span class="va">self</span>.Genotypes.loc[:, [<span class="st">'File'</span>, <span class="st">'Genotype'</span>]</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>                                        ].drop_duplicates(</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>                                        ).merge(<span class="va">self</span>.Ids, how <span class="op">=</span> <span class="st">'left'</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>                                        ).reset_index(drop <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> table <span class="op">==</span> <span class="st">'Ids'</span>:</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.Ids <span class="op">=</span> <span class="va">self</span>.Ids.loc[mask, ].reset_index(drop <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.Genotypes <span class="op">=</span> <span class="va">self</span>.Ids.loc[:, [<span class="st">'File'</span>, <span class="st">'Genotype'</span>]</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>                                    ].drop_duplicates(</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>                                    ).merge(<span class="va">self</span>.Genotypes, how <span class="op">=</span> <span class="st">'left'</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>                                    ).reset_index(drop <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> load_results(<span class="va">self</span>, years <span class="op">=</span> [], dry_run <span class="op">=</span> <span class="va">True</span>):</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.years <span class="op">=</span> years</span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Now we can ask for the files that we should get</span></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>        tmp <span class="op">=</span> <span class="va">self</span>.Ids.loc[:, [<span class="st">'File'</span>, <span class="st">'Genotype'</span>, <span class="st">'FactorialUID'</span>]]</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>        get_files <span class="op">=</span> tmp.File.drop_duplicates().to_list()</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span><span class="bu">len</span>(get_files)<span class="sc">}</span><span class="ss"> files to be read.'</span>)</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> dry_run <span class="op">==</span> <span class="va">True</span>:</span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'In dry_run, reading no files'</span>)</span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> dry_run <span class="op">==</span> <span class="va">False</span>:</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>            res_list <span class="op">=</span> []</span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>            col_order <span class="op">=</span> <span class="st">''</span></span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> tqdm(get_files):</span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>                <span class="co"># print(f'{file}')</span></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>                res <span class="op">=</span> pq.read_table(<span class="ss">f'</span><span class="sc">{</span>x<span class="sc">.</span>results_path<span class="op">+</span><span class="bu">file</span><span class="sc">}</span><span class="ss">.parquet'</span>).to_pandas()</span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>                <span class="co"># columns should be in the same order, but we will force them to be here. </span></span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> col_order <span class="op">==</span> <span class="st">''</span>:</span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>                    col_order <span class="op">=</span> <span class="bu">list</span>(res)</span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>                <span class="co"># filter order established with some informal testing.</span></span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>                <span class="co"># runtime filter years, factorials: [10, 11.3, 10.5]</span></span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>                <span class="co"># runtime filter factorials, years: [9.0, 8.4, 9.6]</span></span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>                <span class="co"># filter factorials</span></span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>                res <span class="op">=</span> tmp.loc[(tmp.File <span class="op">==</span> <span class="bu">file</span>), [<span class="st">'FactorialUID'</span>]].merge(res)</span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>                <span class="co"># filter years</span></span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> years <span class="op">!=</span> []:</span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a>                    yr <span class="op">=</span> _prep_unix_epoch_to_date(max_year <span class="op">=</span> <span class="dv">2030</span>)</span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a>                    yr <span class="op">=</span> yr.loc[(yr.Year.isin(years)), [<span class="st">'Unix'</span>]].rename(columns<span class="op">=</span>{<span class="st">'Unix'</span>:<span class="st">'Date'</span>})</span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a>                    res <span class="op">=</span> yr.merge(res)</span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a>                res_list.append(res)</span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a>            res_list <span class="op">=</span> pd.concat(res_list).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.results <span class="op">=</span> res_list</span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> setup_encoders(<span class="va">self</span>):</span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a>        <span class="co"># create string to num encoders so we can use tensors for all lookups</span></span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a>        Ids <span class="op">=</span> <span class="va">self</span>.Ids</span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.encoder_Genotype <span class="op">=</span> {k:v <span class="cf">for</span> k,v <span class="kw">in</span> <span class="bu">zip</span>(Ids.Genotype.unique(), <span class="bu">range</span>(<span class="bu">len</span>(Ids.Genotype.unique())))}</span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.encoder_File     <span class="op">=</span> {k:v <span class="cf">for</span> k,v <span class="kw">in</span> <span class="bu">zip</span>(Ids.File.unique(),     <span class="bu">range</span>(<span class="bu">len</span>(Ids.File.unique())))}</span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.encoder_SowDate  <span class="op">=</span> {k:v <span class="cf">for</span> k,v <span class="kw">in</span> <span class="bu">zip</span>(Ids.SowDate.unique(),  <span class="bu">range</span>(<span class="bu">len</span>(Ids.SowDate.unique())))}</span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> results_as_arrays(<span class="va">self</span>, output_type <span class="op">=</span> <span class="st">'point'</span>): <span class="co">#output_type = 'sequence'</span></span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true" tabindex="-1"></a>        metadata <span class="op">=</span> [<span class="st">'FactorialUID'</span>, <span class="st">'Year'</span>]</span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true" tabindex="-1"></a>        metrics  <span class="op">=</span> [<span class="st">'Maize.AboveGround.Wt'</span>, <span class="st">'Maize.LAI'</span>, <span class="st">'yield_Kgha'</span>]</span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true" tabindex="-1"></a>        ref <span class="op">=</span> {</span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true" tabindex="-1"></a>            <span class="st">'lookup_names'</span>: metadata,</span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true" tabindex="-1"></a>            <span class="st">'data_names'</span>: metrics,</span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Turn results into tensor</span></span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true" tabindex="-1"></a>        tmp <span class="op">=</span> <span class="va">self</span>.results.merge(_prep_unix_epoch_to_date(max_year <span class="op">=</span> <span class="dv">2025</span>).loc[:, [<span class="st">'Unix'</span>, <span class="st">'Year'</span>, <span class="st">'DOY'</span>]].rename(columns<span class="op">=</span>{<span class="st">'Unix'</span>:<span class="st">'Date'</span>}))</span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true" tabindex="-1"></a>        <span class="co"># find the smallest above ground weight within each year, usethat to get the first date within eacy year and then filter for the values that are &gt;= the within year start.</span></span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true" tabindex="-1"></a>        _ <span class="op">=</span> tmp.loc[:, metadata<span class="op">+</span>[<span class="st">'Maize.AboveGround.Wt'</span>]].groupby(metadata).agg(<span class="st">'min'</span>).reset_index()</span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true" tabindex="-1"></a>        _ <span class="op">=</span> _.merge(tmp).loc[:, metadata<span class="op">+</span>[<span class="st">'Date'</span>]].rename(columns<span class="op">=</span>{<span class="st">'Date'</span>: <span class="st">'YearStart'</span>})</span>
<span id="cb10-112"><a href="#cb10-112" aria-hidden="true" tabindex="-1"></a>        tmp <span class="op">=</span> tmp.merge(_, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb10-113"><a href="#cb10-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-114"><a href="#cb10-114" aria-hidden="true" tabindex="-1"></a>        tmp <span class="op">=</span> tmp.loc[(tmp.Date <span class="op">&gt;=</span> tmp.YearStart), ]</span>
<span id="cb10-115"><a href="#cb10-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-116"><a href="#cb10-116" aria-hidden="true" tabindex="-1"></a>        tmp<span class="op">=</span>tmp.drop(columns<span class="op">=</span>[<span class="st">'YearStart'</span>, <span class="st">'Date'</span>]</span>
<span id="cb10-117"><a href="#cb10-117" aria-hidden="true" tabindex="-1"></a>            ).drop_duplicates(</span>
<span id="cb10-118"><a href="#cb10-118" aria-hidden="true" tabindex="-1"></a>            ).sort_values(metadata<span class="op">+</span>[<span class="st">'DOY'</span>]</span>
<span id="cb10-119"><a href="#cb10-119" aria-hidden="true" tabindex="-1"></a>            ).reset_index(drop <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb10-120"><a href="#cb10-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-121"><a href="#cb10-121" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> output_type <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'point'</span>, <span class="st">'sequence'</span>]:</span>
<span id="cb10-122"><a href="#cb10-122" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'output_type expected to be point or sequence'</span>)</span>
<span id="cb10-123"><a href="#cb10-123" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> output_type <span class="op">==</span> <span class="st">'point'</span>:</span>
<span id="cb10-124"><a href="#cb10-124" aria-hidden="true" tabindex="-1"></a>            ref[<span class="st">'data_dims'</span>] <span class="op">=</span> [<span class="st">'obs'</span>, <span class="st">'metrics'</span>]</span>
<span id="cb10-125"><a href="#cb10-125" aria-hidden="true" tabindex="-1"></a>            <span class="co"># if making point estimates:</span></span>
<span id="cb10-126"><a href="#cb10-126" aria-hidden="true" tabindex="-1"></a>            tmp <span class="op">=</span> tmp.drop(columns<span class="op">=</span><span class="st">'DOY'</span>).groupby(metadata).agg(<span class="st">'max'</span>).reset_index()</span>
<span id="cb10-127"><a href="#cb10-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-128"><a href="#cb10-128" aria-hidden="true" tabindex="-1"></a>            lookup <span class="op">=</span> torch.tensor(tmp.loc[:, metadata].to_numpy())</span>
<span id="cb10-129"><a href="#cb10-129" aria-hidden="true" tabindex="-1"></a>            out <span class="op">=</span> torch.tensor(tmp.drop(columns<span class="op">=</span>metadata).to_numpy())</span>
<span id="cb10-130"><a href="#cb10-130" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-131"><a href="#cb10-131" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> output_type <span class="op">==</span> <span class="st">'sequence'</span>:</span>
<span id="cb10-132"><a href="#cb10-132" aria-hidden="true" tabindex="-1"></a>            ref[<span class="st">'data_dims'</span>] <span class="op">=</span> [<span class="st">'obs'</span>, <span class="st">'days'</span>, <span class="st">'metrics'</span>]</span>
<span id="cb10-133"><a href="#cb10-133" aria-hidden="true" tabindex="-1"></a>            day_lookup <span class="op">=</span> _prep_unix_epoch_to_date(max_year <span class="op">=</span> <span class="dv">2025</span>).rename(columns<span class="op">=</span>{<span class="st">'Unix'</span>:<span class="st">'Date'</span>})</span>
<span id="cb10-134"><a href="#cb10-134" aria-hidden="true" tabindex="-1"></a>            <span class="co"># day_lookup</span></span>
<span id="cb10-135"><a href="#cb10-135" aria-hidden="true" tabindex="-1"></a>            lookup <span class="op">=</span> tmp.loc[:, metadata].drop_duplicates().reset_index(drop <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb10-136"><a href="#cb10-136" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-137"><a href="#cb10-137" aria-hidden="true" tabindex="-1"></a>            <span class="co"># obs, channels, length</span></span>
<span id="cb10-138"><a href="#cb10-138" aria-hidden="true" tabindex="-1"></a>            out <span class="op">=</span> torch.zeros((lookup.shape[<span class="dv">0</span>], </span>
<span id="cb10-139"><a href="#cb10-139" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">365</span>,</span>
<span id="cb10-140"><a href="#cb10-140" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">3</span></span>
<span id="cb10-141"><a href="#cb10-141" aria-hidden="true" tabindex="-1"></a>                            ))</span>
<span id="cb10-142"><a href="#cb10-142" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-143"><a href="#cb10-143" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i <span class="kw">in</span> tqdm(<span class="bu">range</span>(lookup.shape[<span class="dv">0</span>])):</span>
<span id="cb10-144"><a href="#cb10-144" aria-hidden="true" tabindex="-1"></a>                <span class="co"># break</span></span>
<span id="cb10-145"><a href="#cb10-145" aria-hidden="true" tabindex="-1"></a>                uid, yr <span class="op">=</span> lookup.loc[i, ]</span>
<span id="cb10-146"><a href="#cb10-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-147"><a href="#cb10-147" aria-hidden="true" tabindex="-1"></a>                <span class="co"># use Ids table to get planting date. </span></span>
<span id="cb10-148"><a href="#cb10-148" aria-hidden="true" tabindex="-1"></a>                sow_date <span class="op">=</span> <span class="va">self</span>.Ids.loc[(<span class="va">self</span>.Ids.FactorialUID <span class="op">==</span> uid), <span class="st">'SowDate'</span>]</span>
<span id="cb10-149"><a href="#cb10-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-150"><a href="#cb10-150" aria-hidden="true" tabindex="-1"></a>                plant_DOY <span class="op">=</span> day_lookup.loc[(</span>
<span id="cb10-151"><a href="#cb10-151" aria-hidden="true" tabindex="-1"></a>                    (day_lookup.Year <span class="op">==</span> yr) <span class="op">&amp;</span> </span>
<span id="cb10-152"><a href="#cb10-152" aria-hidden="true" tabindex="-1"></a>                    (day_lookup.SowDate <span class="op">==</span> sow_date.values[<span class="dv">0</span>])), <span class="st">'DOY'</span>].values[<span class="dv">0</span>]</span>
<span id="cb10-153"><a href="#cb10-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-154"><a href="#cb10-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-155"><a href="#cb10-155" aria-hidden="true" tabindex="-1"></a>                mask <span class="op">=</span> (</span>
<span id="cb10-156"><a href="#cb10-156" aria-hidden="true" tabindex="-1"></a>                    (tmp.FactorialUID <span class="op">==</span> uid) <span class="op">&amp;</span> </span>
<span id="cb10-157"><a href="#cb10-157" aria-hidden="true" tabindex="-1"></a>                    (tmp.Year <span class="op">==</span> yr) <span class="op">&amp;</span></span>
<span id="cb10-158"><a href="#cb10-158" aria-hidden="true" tabindex="-1"></a>                    (tmp.DOY <span class="op">&gt;=</span> plant_DOY) <span class="op">&amp;</span> </span>
<span id="cb10-159"><a href="#cb10-159" aria-hidden="true" tabindex="-1"></a>                    (tmp.DOY <span class="op">&lt;=</span> <span class="dv">364</span>) <span class="co"># because there are leap years and indexing starts at 0, clip to the minimum of these</span></span>
<span id="cb10-160"><a href="#cb10-160" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb10-161"><a href="#cb10-161" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb10-162"><a href="#cb10-162" aria-hidden="true" tabindex="-1"></a>                start_DOY<span class="op">=</span> tmp.loc[mask, <span class="st">'DOY'</span>].<span class="bu">min</span>()</span>
<span id="cb10-163"><a href="#cb10-163" aria-hidden="true" tabindex="-1"></a>                stop_DOY <span class="op">=</span> tmp.loc[mask, <span class="st">'DOY'</span>].<span class="bu">max</span>()</span>
<span id="cb10-164"><a href="#cb10-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-165"><a href="#cb10-165" aria-hidden="true" tabindex="-1"></a>                out[i, start_DOY:(stop_DOY<span class="op">+</span><span class="dv">1</span>), :] <span class="op">=</span> torch.tensor(tmp.loc[mask, metrics].to_numpy())</span>
<span id="cb10-166"><a href="#cb10-166" aria-hidden="true" tabindex="-1"></a>                <span class="co"># # propagate forward observations to all dates following the max</span></span>
<span id="cb10-167"><a href="#cb10-167" aria-hidden="true" tabindex="-1"></a>                out[i, stop_DOY:<span class="dv">365</span>, :] <span class="op">=</span> out[i, stop_DOY, :]</span>
<span id="cb10-168"><a href="#cb10-168" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-169"><a href="#cb10-169" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span>(lookup, out, ref)  </span>
<span id="cb10-170"><a href="#cb10-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-171"><a href="#cb10-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-172"><a href="#cb10-172" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Working with Environmental Data</span></span>
<span id="cb10-173"><a href="#cb10-173" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> filter_env(<span class="va">self</span>):</span>
<span id="cb10-174"><a href="#cb10-174" aria-hidden="true" tabindex="-1"></a>        <span class="co"># filter to selected years</span></span>
<span id="cb10-175"><a href="#cb10-175" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.years <span class="op">!=</span> []:</span>
<span id="cb10-176"><a href="#cb10-176" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.met_data <span class="op">=</span> <span class="va">self</span>.met_data.loc[(<span class="va">self</span>.met_data.year.isin(<span class="va">self</span>.years)), ].reset_index(drop <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb10-177"><a href="#cb10-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-178"><a href="#cb10-178" aria-hidden="true" tabindex="-1"></a>        <span class="co"># shared soilIdx</span></span>
<span id="cb10-179"><a href="#cb10-179" aria-hidden="true" tabindex="-1"></a>        Ids_idxs <span class="op">=</span> <span class="va">self</span>.Ids.loc[:, [<span class="st">'Longitude'</span>, <span class="st">'Latitude'</span>, <span class="st">'SoilIdx'</span>]].drop_duplicates()</span>
<span id="cb10-180"><a href="#cb10-180" aria-hidden="true" tabindex="-1"></a>        ssurgo_s <span class="op">=</span> <span class="va">self</span>.ssurgo_data.loc[:, [<span class="st">'SoilIdx'</span>]].drop_duplicates()</span>
<span id="cb10-181"><a href="#cb10-181" aria-hidden="true" tabindex="-1"></a>        met_lonlat <span class="op">=</span> <span class="va">self</span>.met_data.loc[:, [<span class="st">'Longitude'</span>, <span class="st">'Latitude'</span>]].drop_duplicates()</span>
<span id="cb10-182"><a href="#cb10-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-183"><a href="#cb10-183" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Uniq. Lon/Lat/Soil: </span><span class="sc">{</span>Ids_idxs<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb10-184"><a href="#cb10-184" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Condition on env availability:'</span>)</span>
<span id="cb10-185"><a href="#cb10-185" aria-hidden="true" tabindex="-1"></a>        Ids_idxs <span class="op">=</span> Ids_idxs.merge(ssurgo_s, how <span class="op">=</span> <span class="st">'inner'</span>).merge(met_lonlat, how <span class="op">=</span> <span class="st">'inner'</span>)</span>
<span id="cb10-186"><a href="#cb10-186" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Uniq. Lon/Lat/Soil: </span><span class="sc">{</span>Ids_idxs<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb10-187"><a href="#cb10-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-188"><a href="#cb10-188" aria-hidden="true" tabindex="-1"></a>        <span class="co"># reduce the environmental datasets:</span></span>
<span id="cb10-189"><a href="#cb10-189" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.met_data    <span class="op">=</span> Ids_idxs.drop(columns<span class="op">=</span>[<span class="st">'SoilIdx'</span>]).drop_duplicates().merge(<span class="va">self</span>.met_data, how <span class="op">=</span> <span class="st">'inner'</span>)</span>
<span id="cb10-190"><a href="#cb10-190" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ssurgo_data <span class="op">=</span> Ids_idxs.drop(columns<span class="op">=</span>[<span class="st">'Longitude'</span>, <span class="st">'Latitude'</span>]).drop_duplicates().merge(<span class="va">self</span>.ssurgo_data, how <span class="op">=</span> <span class="st">'inner'</span>)</span>
<span id="cb10-191"><a href="#cb10-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-192"><a href="#cb10-192" aria-hidden="true" tabindex="-1"></a>        <span class="co"># update Ids &amp; results:</span></span>
<span id="cb10-193"><a href="#cb10-193" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.Ids <span class="op">=</span> Ids_idxs.merge(<span class="va">self</span>.Ids)</span>
<span id="cb10-194"><a href="#cb10-194" aria-hidden="true" tabindex="-1"></a>        _ <span class="op">=</span> <span class="va">self</span>.Ids.loc[:, [<span class="st">'FactorialUID'</span>]].drop_duplicates()</span>
<span id="cb10-195"><a href="#cb10-195" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.results <span class="op">=</span> _.merge(<span class="va">self</span>.results, how<span class="op">=</span><span class="st">'inner'</span>)</span>
<span id="cb10-196"><a href="#cb10-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-197"><a href="#cb10-197" aria-hidden="true" tabindex="-1"></a>        <span class="co"># refresh index on everything</span></span>
<span id="cb10-198"><a href="#cb10-198" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.Ids         <span class="op">=</span> <span class="va">self</span>.Ids.reset_index(        drop <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb10-199"><a href="#cb10-199" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.results     <span class="op">=</span> <span class="va">self</span>.results.reset_index(    drop <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb10-200"><a href="#cb10-200" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.Genotypes   <span class="op">=</span> <span class="va">self</span>.Genotypes.reset_index(  drop <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb10-201"><a href="#cb10-201" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.met_data    <span class="op">=</span> <span class="va">self</span>.met_data.reset_index(   drop <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb10-202"><a href="#cb10-202" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ssurgo_data <span class="op">=</span> <span class="va">self</span>.ssurgo_data.reset_index(drop <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb10-203"><a href="#cb10-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-204"><a href="#cb10-204" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> met_as_arrays(<span class="va">self</span>, ops_string <span class="op">=</span> <span class="st">'s d m -&gt; s d m'</span>): <span class="co"># site day metric</span></span>
<span id="cb10-205"><a href="#cb10-205" aria-hidden="true" tabindex="-1"></a>        m <span class="op">=</span> <span class="va">self</span>.met_data.copy()</span>
<span id="cb10-206"><a href="#cb10-206" aria-hidden="true" tabindex="-1"></a>        m <span class="op">=</span> m.rename(columns <span class="op">=</span> {<span class="st">'year'</span>: <span class="st">'Year'</span>})</span>
<span id="cb10-207"><a href="#cb10-207" aria-hidden="true" tabindex="-1"></a>        metadata <span class="op">=</span> [</span>
<span id="cb10-208"><a href="#cb10-208" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Longitude'</span>, </span>
<span id="cb10-209"><a href="#cb10-209" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Latitude'</span>, </span>
<span id="cb10-210"><a href="#cb10-210" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Year'</span></span>
<span id="cb10-211"><a href="#cb10-211" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb10-212"><a href="#cb10-212" aria-hidden="true" tabindex="-1"></a>        metrics <span class="op">=</span> [</span>
<span id="cb10-213"><a href="#cb10-213" aria-hidden="true" tabindex="-1"></a>            <span class="st">'radn_MJ_div_m2_div_day'</span>,</span>
<span id="cb10-214"><a href="#cb10-214" aria-hidden="true" tabindex="-1"></a>            <span class="st">'maxt_oC'</span>,</span>
<span id="cb10-215"><a href="#cb10-215" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mint_oC'</span>,</span>
<span id="cb10-216"><a href="#cb10-216" aria-hidden="true" tabindex="-1"></a>            <span class="st">'rain_mm'</span>,</span>
<span id="cb10-217"><a href="#cb10-217" aria-hidden="true" tabindex="-1"></a>            <span class="st">'rh_pr'</span>,</span>
<span id="cb10-218"><a href="#cb10-218" aria-hidden="true" tabindex="-1"></a>            <span class="st">'windspeed_m_div_s'</span>,</span>
<span id="cb10-219"><a href="#cb10-219" aria-hidden="true" tabindex="-1"></a>            <span class="st">'tav'</span>,</span>
<span id="cb10-220"><a href="#cb10-220" aria-hidden="true" tabindex="-1"></a>            <span class="st">'amp'</span></span>
<span id="cb10-221"><a href="#cb10-221" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb10-222"><a href="#cb10-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-223"><a href="#cb10-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-224"><a href="#cb10-224" aria-hidden="true" tabindex="-1"></a>        <span class="co"># make sure that there are the expected number of values per group</span></span>
<span id="cb10-225"><a href="#cb10-225" aria-hidden="true" tabindex="-1"></a>        m <span class="op">=</span> m.loc[(m.day <span class="op">&lt;</span> <span class="dv">366</span>), ].sort_values(metadata).reset_index(drop <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb10-226"><a href="#cb10-226" aria-hidden="true" tabindex="-1"></a>        <span class="co"># there's at least one site that appears to have at least two records. I'll deal with this by (tav and amp appear to be slightly different)</span></span>
<span id="cb10-227"><a href="#cb10-227" aria-hidden="true" tabindex="-1"></a>        <span class="co"># see m.loc[((m.Longitude == -86.529600) &amp; (m.Latitude == 34.729520) &amp; (m.year == 2014) ), ].drop_duplicates().sort_values('day')</span></span>
<span id="cb10-228"><a href="#cb10-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-229"><a href="#cb10-229" aria-hidden="true" tabindex="-1"></a>        m <span class="op">=</span> m.groupby(metadata<span class="op">+</span>[<span class="st">'day'</span>]).mean().reset_index()</span>
<span id="cb10-230"><a href="#cb10-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-231"><a href="#cb10-231" aria-hidden="true" tabindex="-1"></a>        <span class="co"># all groups have 365 obs?</span></span>
<span id="cb10-232"><a href="#cb10-232" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> <span class="va">False</span> <span class="kw">not</span> <span class="kw">in</span> (m.groupby(metadata).count().reset_index().loc[:, [<span class="st">'day'</span>]] <span class="op">==</span> <span class="dv">365</span>).values</span>
<span id="cb10-233"><a href="#cb10-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-234"><a href="#cb10-234" aria-hidden="true" tabindex="-1"></a>        lookup <span class="op">=</span> m.loc[:, metadata].drop_duplicates().to_numpy()</span>
<span id="cb10-235"><a href="#cb10-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-236"><a href="#cb10-236" aria-hidden="true" tabindex="-1"></a>        m <span class="op">=</span> m.loc[:, metrics</span>
<span id="cb10-237"><a href="#cb10-237" aria-hidden="true" tabindex="-1"></a>            ].to_numpy(</span>
<span id="cb10-238"><a href="#cb10-238" aria-hidden="true" tabindex="-1"></a>            ).reshape(</span>
<span id="cb10-239"><a href="#cb10-239" aria-hidden="true" tabindex="-1"></a>                <span class="op">-</span><span class="dv">1</span>,           <span class="co"># as many sites as are available</span></span>
<span id="cb10-240"><a href="#cb10-240" aria-hidden="true" tabindex="-1"></a>                <span class="dv">365</span>,          <span class="co"># days</span></span>
<span id="cb10-241"><a href="#cb10-241" aria-hidden="true" tabindex="-1"></a>                <span class="bu">len</span>(metrics)) <span class="co"># metrics</span></span>
<span id="cb10-242"><a href="#cb10-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-243"><a href="#cb10-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-244"><a href="#cb10-244" aria-hidden="true" tabindex="-1"></a>        m <span class="op">=</span> einops.rearrange(m, ops_string)</span>
<span id="cb10-245"><a href="#cb10-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-246"><a href="#cb10-246" aria-hidden="true" tabindex="-1"></a>        <span class="co"># let's also allow for an operations string so that we can _request_ data in a specific format instead of changing it after the fact.</span></span>
<span id="cb10-247"><a href="#cb10-247" aria-hidden="true" tabindex="-1"></a>        ops <span class="op">=</span> ops_string.replace(<span class="st">' '</span>, <span class="st">''</span>).split(<span class="st">'-&gt;'</span>)</span>
<span id="cb10-248"><a href="#cb10-248" aria-hidden="true" tabindex="-1"></a>        dim_order <span class="op">=</span> [i</span>
<span id="cb10-249"><a href="#cb10-249" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> e <span class="kw">in</span> ops[<span class="dv">1</span>]</span>
<span id="cb10-250"><a href="#cb10-250" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(ops[<span class="dv">0</span>]))</span>
<span id="cb10-251"><a href="#cb10-251" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> e <span class="op">==</span> ops[<span class="dv">0</span>][i]</span>
<span id="cb10-252"><a href="#cb10-252" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb10-253"><a href="#cb10-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-254"><a href="#cb10-254" aria-hidden="true" tabindex="-1"></a>        ref <span class="op">=</span> {</span>
<span id="cb10-255"><a href="#cb10-255" aria-hidden="true" tabindex="-1"></a>            <span class="st">'lookup_names'</span>: metadata,</span>
<span id="cb10-256"><a href="#cb10-256" aria-hidden="true" tabindex="-1"></a>            <span class="st">'data_names'</span>: metrics,</span>
<span id="cb10-257"><a href="#cb10-257" aria-hidden="true" tabindex="-1"></a>            <span class="st">'data_dims'</span>: [[<span class="st">'site'</span>, <span class="st">'days'</span>, <span class="st">'metrics'</span>][i] <span class="cf">for</span> i <span class="kw">in</span> dim_order] <span class="co"># use the ops string to figure out the order that will be returned</span></span>
<span id="cb10-258"><a href="#cb10-258" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb10-259"><a href="#cb10-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-260"><a href="#cb10-260" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (lookup, m, ref)</span>
<span id="cb10-261"><a href="#cb10-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-262"><a href="#cb10-262" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> ssurgo_as_arrays(<span class="va">self</span>, ops_string <span class="op">=</span> <span class="st">'s l m -&gt; s l m'</span>): <span class="co"># site lenght (depth) metric</span></span>
<span id="cb10-263"><a href="#cb10-263" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> <span class="va">self</span>.ssurgo_data.copy()</span>
<span id="cb10-264"><a href="#cb10-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-265"><a href="#cb10-265" aria-hidden="true" tabindex="-1"></a>        metadata <span class="op">=</span> [</span>
<span id="cb10-266"><a href="#cb10-266" aria-hidden="true" tabindex="-1"></a>            <span class="st">'SoilIdx'</span>,</span>
<span id="cb10-267"><a href="#cb10-267" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb10-268"><a href="#cb10-268" aria-hidden="true" tabindex="-1"></a>        metrics <span class="op">=</span> [</span>
<span id="cb10-269"><a href="#cb10-269" aria-hidden="true" tabindex="-1"></a>            <span class="st">'BD'</span>,</span>
<span id="cb10-270"><a href="#cb10-270" aria-hidden="true" tabindex="-1"></a>            <span class="st">'AirDry'</span>,</span>
<span id="cb10-271"><a href="#cb10-271" aria-hidden="true" tabindex="-1"></a>            <span class="st">'LL15'</span>,</span>
<span id="cb10-272"><a href="#cb10-272" aria-hidden="true" tabindex="-1"></a>            <span class="st">'DUL'</span>,</span>
<span id="cb10-273"><a href="#cb10-273" aria-hidden="true" tabindex="-1"></a>            <span class="st">'SAT'</span>,</span>
<span id="cb10-274"><a href="#cb10-274" aria-hidden="true" tabindex="-1"></a>            <span class="st">'KS'</span>,</span>
<span id="cb10-275"><a href="#cb10-275" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Carbon'</span>,</span>
<span id="cb10-276"><a href="#cb10-276" aria-hidden="true" tabindex="-1"></a>            <span class="st">'SoilCNRatio'</span>,</span>
<span id="cb10-277"><a href="#cb10-277" aria-hidden="true" tabindex="-1"></a>            <span class="st">'FOM'</span>,</span>
<span id="cb10-278"><a href="#cb10-278" aria-hidden="true" tabindex="-1"></a>            <span class="st">'FOM.CN'</span>,</span>
<span id="cb10-279"><a href="#cb10-279" aria-hidden="true" tabindex="-1"></a>            <span class="st">'FBiom'</span>,</span>
<span id="cb10-280"><a href="#cb10-280" aria-hidden="true" tabindex="-1"></a>            <span class="st">'FInert'</span>,</span>
<span id="cb10-281"><a href="#cb10-281" aria-hidden="true" tabindex="-1"></a>            <span class="st">'NO3N'</span>,</span>
<span id="cb10-282"><a href="#cb10-282" aria-hidden="true" tabindex="-1"></a>            <span class="st">'NH4N'</span>,</span>
<span id="cb10-283"><a href="#cb10-283" aria-hidden="true" tabindex="-1"></a>            <span class="st">'PH'</span>,</span>
<span id="cb10-284"><a href="#cb10-284" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ParticleSizeClay'</span>,</span>
<span id="cb10-285"><a href="#cb10-285" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ParticleSizeSilt'</span>,</span>
<span id="cb10-286"><a href="#cb10-286" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ParticleSizeSand'</span>,</span>
<span id="cb10-287"><a href="#cb10-287" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Maize.KL'</span>,</span>
<span id="cb10-288"><a href="#cb10-288" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Maize.LL'</span>,</span>
<span id="cb10-289"><a href="#cb10-289" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Maize.XF'</span>,</span>
<span id="cb10-290"><a href="#cb10-290" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 'Soybean.KL',</span></span>
<span id="cb10-291"><a href="#cb10-291" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 'Soybean.LL',</span></span>
<span id="cb10-292"><a href="#cb10-292" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 'Soybean.XF',</span></span>
<span id="cb10-293"><a href="#cb10-293" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 'Wheat.KL',</span></span>
<span id="cb10-294"><a href="#cb10-294" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 'Wheat.LL',</span></span>
<span id="cb10-295"><a href="#cb10-295" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 'Wheat.XF'</span></span>
<span id="cb10-296"><a href="#cb10-296" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb10-297"><a href="#cb10-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-298"><a href="#cb10-298" aria-hidden="true" tabindex="-1"></a>        <span class="co"># check that the soil slices are equally sized</span></span>
<span id="cb10-299"><a href="#cb10-299" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> <span class="bu">len</span>(s.Thickness.unique()) <span class="op">==</span> <span class="dv">1</span></span>
<span id="cb10-300"><a href="#cb10-300" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Soil compartment thickness: </span><span class="sc">{</span>s<span class="sc">.</span>Thickness[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb10-301"><a href="#cb10-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-302"><a href="#cb10-302" aria-hidden="true" tabindex="-1"></a>        <span class="co"># check that there are an equal number of slices</span></span>
<span id="cb10-303"><a href="#cb10-303" aria-hidden="true" tabindex="-1"></a>        _  <span class="op">=</span> s.loc[:, [<span class="st">'SoilIdx'</span>, <span class="st">'Thickness'</span>]].groupby([<span class="st">'SoilIdx'</span>]).count().reset_index()</span>
<span id="cb10-304"><a href="#cb10-304" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> _.Thickness.<span class="bu">min</span>() <span class="op">==</span> _.Thickness.<span class="bu">max</span>()</span>
<span id="cb10-305"><a href="#cb10-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-306"><a href="#cb10-306" aria-hidden="true" tabindex="-1"></a>        <span class="co"># turn range into start of slice</span></span>
<span id="cb10-307"><a href="#cb10-307" aria-hidden="true" tabindex="-1"></a>        s[<span class="st">'Depth'</span>] <span class="op">=</span> s[<span class="st">'Depth'</span>].<span class="bu">str</span>.split(pat <span class="op">=</span> <span class="st">'-'</span>, expand <span class="op">=</span> <span class="va">True</span>)[<span class="dv">0</span>].astype(<span class="bu">int</span>)</span>
<span id="cb10-308"><a href="#cb10-308" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> s.sort_values([<span class="st">'SoilIdx'</span>, <span class="st">'Depth'</span>]).reset_index(drop <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb10-309"><a href="#cb10-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-310"><a href="#cb10-310" aria-hidden="true" tabindex="-1"></a>        lookup <span class="op">=</span> s.loc[:, metadata].drop_duplicates().to_numpy()</span>
<span id="cb10-311"><a href="#cb10-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-312"><a href="#cb10-312" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> s.loc[:, metrics].to_numpy()</span>
<span id="cb10-313"><a href="#cb10-313" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> s.reshape(<span class="op">-</span><span class="dv">1</span>, lookup.shape[<span class="dv">0</span>], <span class="bu">len</span>(metrics))</span>
<span id="cb10-314"><a href="#cb10-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-315"><a href="#cb10-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-316"><a href="#cb10-316" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> einops.rearrange(s, ops_string)</span>
<span id="cb10-317"><a href="#cb10-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-318"><a href="#cb10-318" aria-hidden="true" tabindex="-1"></a>        <span class="co"># let's also allow for an operations string so that we can _request_ data in a specific format instead of changing it after the fact.</span></span>
<span id="cb10-319"><a href="#cb10-319" aria-hidden="true" tabindex="-1"></a>        ops <span class="op">=</span> ops_string.replace(<span class="st">' '</span>, <span class="st">''</span>).split(<span class="st">'-&gt;'</span>)</span>
<span id="cb10-320"><a href="#cb10-320" aria-hidden="true" tabindex="-1"></a>        dim_order <span class="op">=</span> [i</span>
<span id="cb10-321"><a href="#cb10-321" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> e <span class="kw">in</span> ops[<span class="dv">1</span>]</span>
<span id="cb10-322"><a href="#cb10-322" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(ops[<span class="dv">0</span>]))</span>
<span id="cb10-323"><a href="#cb10-323" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> e <span class="op">==</span> ops[<span class="dv">0</span>][i]</span>
<span id="cb10-324"><a href="#cb10-324" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb10-325"><a href="#cb10-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-326"><a href="#cb10-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-327"><a href="#cb10-327" aria-hidden="true" tabindex="-1"></a>        ref <span class="op">=</span> {</span>
<span id="cb10-328"><a href="#cb10-328" aria-hidden="true" tabindex="-1"></a>            <span class="st">'lookup_names'</span>: metadata,</span>
<span id="cb10-329"><a href="#cb10-329" aria-hidden="true" tabindex="-1"></a>            <span class="st">'data_names'</span>: metrics,</span>
<span id="cb10-330"><a href="#cb10-330" aria-hidden="true" tabindex="-1"></a>            <span class="st">'data_dims'</span>: [[<span class="st">'site'</span>, <span class="st">'depth'</span>, <span class="st">'metrics'</span>][i] <span class="cf">for</span> i <span class="kw">in</span> dim_order] <span class="co"># use the ops string to figure out the order that will be returned</span></span>
<span id="cb10-331"><a href="#cb10-331" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb10-332"><a href="#cb10-332" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (lookup, s, ref)</span>
<span id="cb10-333"><a href="#cb10-333" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-334"><a href="#cb10-334" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> genotype_as_arrays(<span class="va">self</span>):</span>
<span id="cb10-335"><a href="#cb10-335" aria-hidden="true" tabindex="-1"></a>        g <span class="op">=</span> <span class="va">self</span>.Genotypes.copy()</span>
<span id="cb10-336"><a href="#cb10-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-337"><a href="#cb10-337" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Genotypes are easy to deal with because the table is cleaned up in filtering results. </span></span>
<span id="cb10-338"><a href="#cb10-338" aria-hidden="true" tabindex="-1"></a>        metadata <span class="op">=</span> [</span>
<span id="cb10-339"><a href="#cb10-339" aria-hidden="true" tabindex="-1"></a>            <span class="st">'File'</span>,</span>
<span id="cb10-340"><a href="#cb10-340" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Genotype'</span>,</span>
<span id="cb10-341"><a href="#cb10-341" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb10-342"><a href="#cb10-342" aria-hidden="true" tabindex="-1"></a>        metrics <span class="op">=</span> [</span>
<span id="cb10-343"><a href="#cb10-343" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Grain.MaximumGrainsPerCob.FixedValue'</span>,</span>
<span id="cb10-344"><a href="#cb10-344" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Grain.MaximumPotentialGrainSize.FixedValue'</span>,</span>
<span id="cb10-345"><a href="#cb10-345" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Phenology.FlagLeafToFlowering.Target.FixedValue'</span>,</span>
<span id="cb10-346"><a href="#cb10-346" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Phenology.FloweringToGrainFilling.Target.FixedValue'</span>,</span>
<span id="cb10-347"><a href="#cb10-347" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Phenology.GrainFilling.Target.FixedValue'</span>,</span>
<span id="cb10-348"><a href="#cb10-348" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Phenology.Juvenile.Target.FixedValue'</span>,</span>
<span id="cb10-349"><a href="#cb10-349" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Phenology.Maturing.Target.FixedValue'</span>,</span>
<span id="cb10-350"><a href="#cb10-350" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Phenology.MaturityToHarvestRipe.Target.FixedValue'</span>,</span>
<span id="cb10-351"><a href="#cb10-351" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Phenology.Photosensitive.Target.XYPairs.X__1'</span>,</span>
<span id="cb10-352"><a href="#cb10-352" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Phenology.Photosensitive.Target.XYPairs.X__2'</span>,</span>
<span id="cb10-353"><a href="#cb10-353" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Phenology.Photosensitive.Target.XYPairs.X__3'</span>,</span>
<span id="cb10-354"><a href="#cb10-354" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Phenology.Photosensitive.Target.XYPairs.Y__1'</span>,</span>
<span id="cb10-355"><a href="#cb10-355" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Phenology.Photosensitive.Target.XYPairs.Y__2'</span>,</span>
<span id="cb10-356"><a href="#cb10-356" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Phenology.Photosensitive.Target.XYPairs.Y__3'</span>,</span>
<span id="cb10-357"><a href="#cb10-357" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Rachis.DMDemands.Structural.DMDemandFunction.MaximumOrganWt.FixedValue'</span>,</span>
<span id="cb10-358"><a href="#cb10-358" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb10-359"><a href="#cb10-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-360"><a href="#cb10-360" aria-hidden="true" tabindex="-1"></a>        lookup <span class="op">=</span> g.loc[:, metadata]</span>
<span id="cb10-361"><a href="#cb10-361" aria-hidden="true" tabindex="-1"></a>        lookup.File     <span class="op">=</span> [<span class="va">self</span>.encoder_File[e]     <span class="cf">for</span> e <span class="kw">in</span> lookup.File]</span>
<span id="cb10-362"><a href="#cb10-362" aria-hidden="true" tabindex="-1"></a>        lookup.Genotype <span class="op">=</span> [<span class="va">self</span>.encoder_Genotype[e] <span class="cf">for</span> e <span class="kw">in</span> lookup.Genotype]</span>
<span id="cb10-363"><a href="#cb10-363" aria-hidden="true" tabindex="-1"></a>        lookup <span class="op">=</span> lookup.to_numpy()</span>
<span id="cb10-364"><a href="#cb10-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-365"><a href="#cb10-365" aria-hidden="true" tabindex="-1"></a>        g <span class="op">=</span> g.loc[:, metrics].to_numpy()</span>
<span id="cb10-366"><a href="#cb10-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-367"><a href="#cb10-367" aria-hidden="true" tabindex="-1"></a>        ref <span class="op">=</span> {</span>
<span id="cb10-368"><a href="#cb10-368" aria-hidden="true" tabindex="-1"></a>            <span class="st">'lookup_names'</span>: metadata,</span>
<span id="cb10-369"><a href="#cb10-369" aria-hidden="true" tabindex="-1"></a>            <span class="st">'data_names'</span>: metrics,</span>
<span id="cb10-370"><a href="#cb10-370" aria-hidden="true" tabindex="-1"></a>            <span class="st">'data_dims'</span>: (<span class="st">'genotype'</span>, <span class="st">'metrics'</span>)</span>
<span id="cb10-371"><a href="#cb10-371" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb10-372"><a href="#cb10-372" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span>(lookup, g, ref)</span>
<span id="cb10-373"><a href="#cb10-373" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-374"><a href="#cb10-374" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> ids_as_arrays(<span class="va">self</span>):</span>
<span id="cb10-375"><a href="#cb10-375" aria-hidden="true" tabindex="-1"></a>        Ids <span class="op">=</span>  <span class="va">self</span>.Ids.copy()</span>
<span id="cb10-376"><a href="#cb10-376" aria-hidden="true" tabindex="-1"></a>        <span class="co"># apply encoder</span></span>
<span id="cb10-377"><a href="#cb10-377" aria-hidden="true" tabindex="-1"></a>        Ids.Genotype <span class="op">=</span> [<span class="va">self</span>.encoder_Genotype[e] <span class="cf">for</span> e <span class="kw">in</span> Ids.Genotype]</span>
<span id="cb10-378"><a href="#cb10-378" aria-hidden="true" tabindex="-1"></a>        Ids.File     <span class="op">=</span> [<span class="va">self</span>.encoder_File[e]     <span class="cf">for</span> e <span class="kw">in</span> Ids.File]</span>
<span id="cb10-379"><a href="#cb10-379" aria-hidden="true" tabindex="-1"></a>        Ids.SowDate  <span class="op">=</span> [<span class="va">self</span>.encoder_SowDate[e]  <span class="cf">for</span> e <span class="kw">in</span> Ids.SowDate]</span>
<span id="cb10-380"><a href="#cb10-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-381"><a href="#cb10-381" aria-hidden="true" tabindex="-1"></a>        ref <span class="op">=</span> {<span class="st">'lookup_names'</span>: <span class="bu">list</span>(Ids),}</span>
<span id="cb10-382"><a href="#cb10-382" aria-hidden="true" tabindex="-1"></a>        Ids <span class="op">=</span> Ids.to_numpy()</span>
<span id="cb10-383"><a href="#cb10-383" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span>(Ids, ref)</span>
<span id="cb10-384"><a href="#cb10-384" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-385"><a href="#cb10-385" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> sowing_as_array(<span class="va">self</span>):</span>
<span id="cb10-386"><a href="#cb10-386" aria-hidden="true" tabindex="-1"></a>        <span class="co"># precompute Year/SowDate -&gt; Planting DOY</span></span>
<span id="cb10-387"><a href="#cb10-387" aria-hidden="true" tabindex="-1"></a>        _ <span class="op">=</span> pd.DataFrame([(y, s) <span class="cf">for</span> y <span class="kw">in</span> <span class="va">self</span>.years <span class="cf">for</span> s <span class="kw">in</span> <span class="va">self</span>.encoder_SowDate], columns<span class="op">=</span>[<span class="st">'Year'</span>, <span class="st">'SowDate'</span>])</span>
<span id="cb10-388"><a href="#cb10-388" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add in DOY</span></span>
<span id="cb10-389"><a href="#cb10-389" aria-hidden="true" tabindex="-1"></a>        _<span class="op">=</span>_.merge(_prep_unix_epoch_to_date(max_year <span class="op">=</span> <span class="dv">2025</span>).loc[:, [<span class="st">'Year'</span>, <span class="st">'SowDate'</span>, <span class="st">'DOY'</span>]])</span>
<span id="cb10-390"><a href="#cb10-390" aria-hidden="true" tabindex="-1"></a>        <span class="co"># overwrite SowDate with encoded version</span></span>
<span id="cb10-391"><a href="#cb10-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-392"><a href="#cb10-392" aria-hidden="true" tabindex="-1"></a>        _.SowDate <span class="op">=</span> [x.encoder_SowDate[e] <span class="cf">for</span> e <span class="kw">in</span> _.SowDate]</span>
<span id="cb10-393"><a href="#cb10-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-394"><a href="#cb10-394" aria-hidden="true" tabindex="-1"></a>        ref <span class="op">=</span> {</span>
<span id="cb10-395"><a href="#cb10-395" aria-hidden="true" tabindex="-1"></a>            <span class="st">'lookup_names'</span>: <span class="bu">list</span>(_)</span>
<span id="cb10-396"><a href="#cb10-396" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb10-397"><a href="#cb10-397" aria-hidden="true" tabindex="-1"></a>        planting_lookup <span class="op">=</span> _.to_numpy()</span>
<span id="cb10-398"><a href="#cb10-398" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-399"><a href="#cb10-399" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span>(planting_lookup, ref)</span>
<span id="cb10-400"><a href="#cb10-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-401"><a href="#cb10-401" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> data_helper(</span>
<span id="cb10-402"><a href="#cb10-402" aria-hidden="true" tabindex="-1"></a>    genotypes_path <span class="op">=</span> apsimx_sim_parquet_dir<span class="op">+</span><span class="st">'/'</span><span class="op">+</span><span class="st">'Genotypes.parquet'</span>,</span>
<span id="cb10-403"><a href="#cb10-403" aria-hidden="true" tabindex="-1"></a>    ids_path <span class="op">=</span> apsimx_sim_parquet_dir<span class="op">+</span><span class="st">'/'</span><span class="op">+</span><span class="st">'Ids.parquet'</span>,</span>
<span id="cb10-404"><a href="#cb10-404" aria-hidden="true" tabindex="-1"></a>    results_path <span class="op">=</span> apsimx_sim_parquet_dir,</span>
<span id="cb10-405"><a href="#cb10-405" aria-hidden="true" tabindex="-1"></a>    ssurgo_path <span class="op">=</span> <span class="st">'/home/Shared/apsimx_env_data/apsimx_i_soil_ssurgo_profile.parquet'</span>,</span>
<span id="cb10-406"><a href="#cb10-406" aria-hidden="true" tabindex="-1"></a>    met_path    <span class="op">=</span> <span class="st">'/home/Shared/apsimx_env_data/apsimx_i_soil_POWER_met.parquet'</span></span>
<span id="cb10-407"><a href="#cb10-407" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-408"><a href="#cb10-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-409"><a href="#cb10-409" aria-hidden="true" tabindex="-1"></a><span class="co"># restrict to simulated cultivars with the maximum MaximumGrainsPerCob</span></span>
<span id="cb10-410"><a href="#cb10-410" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> (x.Genotypes[<span class="st">'Grain.MaximumGrainsPerCob.FixedValue'</span>] <span class="op">==</span> x.Genotypes[<span class="st">'Grain.MaximumGrainsPerCob.FixedValue'</span>].<span class="bu">max</span>())</span>
<span id="cb10-411"><a href="#cb10-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-412"><a href="#cb10-412" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Before Mask: Genotypes: </span><span class="sc">{</span>x<span class="sc">.</span>Genotypes<span class="sc">.</span>shape<span class="sc">}</span><span class="ss"> Ids: </span><span class="sc">{</span>x<span class="sc">.</span>Ids<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb10-413"><a href="#cb10-413" aria-hidden="true" tabindex="-1"></a>x.apply_mask(table<span class="op">=</span><span class="st">'Genotypes'</span>, mask<span class="op">=</span>mask)</span>
<span id="cb10-414"><a href="#cb10-414" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'After Mask: Genotypes: </span><span class="sc">{</span>x<span class="sc">.</span>Genotypes<span class="sc">.</span>shape<span class="sc">}</span><span class="ss"> Ids: </span><span class="sc">{</span>x<span class="sc">.</span>Ids<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb10-415"><a href="#cb10-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-416"><a href="#cb10-416" aria-hidden="true" tabindex="-1"></a>x.setup_encoders()</span>
<span id="cb10-417"><a href="#cb10-417" aria-hidden="true" tabindex="-1"></a>x.load_results(years <span class="op">=</span> [<span class="dv">1990</span>, <span class="dv">2000</span>, <span class="dv">2010</span>, <span class="dv">2020</span>], dry_run <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb10-418"><a href="#cb10-418" aria-hidden="true" tabindex="-1"></a>x.filter_env()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Before Mask: Genotypes: (3150, 17) Ids: (2837275, 7)
After Mask: Genotypes: (5, 17) Ids: (4247, 7)
5 files to be read.
Uniq. Lon/Lat/Soil: 126
Condition on env availability:
Uniq. Lon/Lat/Soil: 109</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████| 5/5 [00:25&lt;00:00,  5.12s/it]</code></pre>
</div>
</div>
<div id="cell-10" class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>result_lookup,   result,   result_ref   <span class="op">=</span> x.results_as_arrays(output_type <span class="op">=</span> <span class="st">'point'</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>genotype_lookup, genotype, genotype_ref <span class="op">=</span> x.genotype_as_arrays()</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>met_lookup,      met,      met_ref      <span class="op">=</span> x.met_as_arrays(   ops_string <span class="op">=</span> <span class="st">'s d m -&gt; s d m'</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>ssurgo_lookup,   ssurgo,   ssurgo_ref   <span class="op">=</span> x.ssurgo_as_arrays(ops_string <span class="op">=</span> <span class="st">'s l m -&gt; s l m'</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>ids_lookup,                ids_ref      <span class="op">=</span> x.ids_as_arrays()</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>sow_lookup,                sow_ref      <span class="op">=</span> x.sowing_as_array()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Soil compartment thickness: 200.0</code></pre>
</div>
</div>
<div id="cell-11" class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># # precompute Year/SowDate -&gt; Planting DOY</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># _ = pd.DataFrame([(y, s) for y in x.years for s in x.encoder_SowDate], columns=['Year', 'SowDate'])</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># # Add in DOY</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># _=_.merge(_prep_unix_epoch_to_date(max_year = 2025).loc[:, ['Year', 'SowDate', 'DOY']])</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co"># # overwrite SowDate with encoded version</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co"># _.SowDate = [x.encoder_SowDate[e] for e in _.SowDate]</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co"># _</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-12" class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> apsimxDataset(Dataset):</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>, </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>            result_lookup,   result,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>            ids_lookup,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>            sow_lookup,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>            sow_met_concat, <span class="co"># TRUE</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>            genotype_lookup, genotype,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>            met_lookup,      met,</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>            ssurgo_lookup,   ssurgo,</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>            ):</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># super().__init__()</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.result_lookup <span class="op">=</span> result_lookup</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.result <span class="op">=</span> result</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ids_lookup <span class="op">=</span> ids_lookup</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sow_lookup <span class="op">=</span> sow_lookup</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sow_met_concat <span class="op">=</span> sow_met_concat</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.genotype_lookup <span class="op">=</span> genotype_lookup</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.genotype <span class="op">=</span> genotype</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.met_lookup <span class="op">=</span> met_lookup</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.met <span class="op">=</span> met</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ssurgo_lookup <span class="op">=</span> ssurgo_lookup</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ssurgo <span class="op">=</span> ssurgo</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.result_lookup.shape[<span class="dv">0</span>])</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx):</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># setup keys</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get keys from y</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>        FactorialUID, Year <span class="op">=</span> <span class="va">self</span>.result_lookup[idx, ]</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get use ids to get env keys from Ids table</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>        Longitude, Latitude, SoilIdx, File, Genotype, SowDate, FactorialUID <span class="op">=</span> <span class="va">self</span>.ids_lookup[(<span class="va">self</span>.ids_lookup[:, <span class="dv">6</span>] <span class="op">==</span> <span class="bu">int</span>(FactorialUID)), ].squeeze()</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># now we have the full set of keys.</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get output values</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> <span class="va">self</span>.result[idx]</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># cultivar variables</span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> (</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>            (<span class="va">self</span>.genotype_lookup[:, <span class="dv">0</span>] <span class="op">==</span> File) <span class="op">&amp;</span> </span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>            (<span class="va">self</span>.genotype_lookup[:, <span class="dv">1</span>] <span class="op">==</span> Genotype)</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>        cultivar <span class="op">=</span> <span class="va">self</span>.genotype[mask, ]</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ssurgo data</span></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> (<span class="va">self</span>.ssurgo_lookup[:, <span class="dv">0</span>] <span class="op">==</span> <span class="bu">int</span>(SoilIdx))</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>        ssurgo <span class="op">=</span> <span class="va">self</span>.ssurgo[:, mask, :]</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># met data</span></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> (</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>            (<span class="va">self</span>.met_lookup[:, <span class="dv">0</span>] <span class="op">==</span> Longitude) <span class="op">&amp;</span> </span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>            (<span class="va">self</span>.met_lookup[:, <span class="dv">1</span>] <span class="op">==</span> Latitude) <span class="op">&amp;</span> </span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>            (<span class="va">self</span>.met_lookup[:, <span class="dv">2</span>] <span class="op">==</span> <span class="bu">float</span>(Year)) </span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>        met <span class="op">=</span> <span class="va">self</span>.met[mask, :, :]</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.sow_met_concat:</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Concatenate a column with 0/1 for whether sowing has occured.</span></span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>            mask <span class="op">=</span> (</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>                (<span class="va">self</span>.sow_lookup[:, <span class="dv">0</span>] <span class="op">==</span> Year) <span class="op">&amp;</span></span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>                (<span class="va">self</span>.sow_lookup[:, <span class="dv">1</span>] <span class="op">==</span> SowDate)</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>            sow_doy <span class="op">=</span> <span class="va">self</span>.sow_lookup[mask, <span class="dv">2</span>]</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>            _ <span class="op">=</span> torch.zeros([<span class="dv">365</span>])</span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>            _[sow_doy:] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>            met <span class="op">=</span> torch.concat([met, _[<span class="va">None</span>, :, <span class="va">None</span>]], axis <span class="op">=</span> <span class="dv">2</span>)</span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (y, cultivar, ssurgo, met)</span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>dat <span class="op">=</span> apsimxDataset(</span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>    result_lookup   <span class="op">=</span> result_lookup,   </span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a>    result          <span class="op">=</span> result,</span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a>    ids_lookup      <span class="op">=</span> torch.tensor(ids_lookup),</span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>    sow_lookup      <span class="op">=</span> torch.tensor(sow_lookup),</span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a>    sow_met_concat  <span class="op">=</span> <span class="va">True</span>,</span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>    genotype_lookup <span class="op">=</span> torch.tensor(genotype_lookup), </span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a>    genotype        <span class="op">=</span> torch.tensor(genotype),</span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a>    met_lookup      <span class="op">=</span> torch.tensor(met_lookup),      </span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a>    met             <span class="op">=</span> torch.tensor(met),</span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a>    ssurgo_lookup   <span class="op">=</span> torch.tensor(ssurgo_lookup),   </span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a>    ssurgo          <span class="op">=</span> torch.tensor(ssurgo),</span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-85"><a href="#cb16-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-86"><a href="#cb16-86" aria-hidden="true" tabindex="-1"></a>i_y, i_cultivar, i_ssurgo, i_met <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(dat))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-14" class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># core of the dataloader</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>result_lookup.shape[<span class="dv">0</span>] <span class="co"># number of ys</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>i <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co"># y variable</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>result[i]</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co"># x variables</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co">## </span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co"># get keys from y</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>FactorialUID, Year <span class="op">=</span> result_lookup[i, ]</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co"># get use ids to get env keys from Ids table</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>Longitude, Latitude, SoilIdx, File, Genotype, SowDate, FactorialUID <span class="op">=</span> Ids[(Ids[:, <span class="dv">6</span>] <span class="op">==</span> <span class="bu">int</span>(FactorialUID)), ].squeeze()</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="co"># now we have the full set of keys.</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="co"># cultivar variables</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> (</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    (genotype_lookup[:, <span class="dv">0</span>] <span class="op">==</span> File) <span class="op">&amp;</span> </span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    (genotype_lookup[:, <span class="dv">1</span>] <span class="op">==</span> Genotype)</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>genotype[mask, ]</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="co"># ssurgo data</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> (ssurgo_lookup[:, <span class="dv">0</span>] <span class="op">==</span> <span class="bu">int</span>(SoilIdx))</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>ssurgo[:, mask, :]</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a><span class="co"># met data</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> (</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    (met_lookup[:, <span class="dv">0</span>] <span class="op">==</span> Longitude) <span class="op">&amp;</span> </span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    (met_lookup[:, <span class="dv">1</span>] <span class="op">==</span> Latitude) <span class="op">&amp;</span> </span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    (met_lookup[:, <span class="dv">2</span>] <span class="op">==</span> <span class="bu">float</span>(Year)) </span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>met[mask, :, :]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-16" class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># recreate data_helper so that we can look at how the methods in data_helper work</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> data_helper(</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    genotypes_path <span class="op">=</span> apsimx_sim_parquet_dir<span class="op">+</span><span class="st">'/'</span><span class="op">+</span><span class="st">'Genotypes.parquet'</span>,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    ids_path <span class="op">=</span> apsimx_sim_parquet_dir<span class="op">+</span><span class="st">'/'</span><span class="op">+</span><span class="st">'Ids.parquet'</span>,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    results_path <span class="op">=</span> apsimx_sim_parquet_dir,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    ssurgo_path <span class="op">=</span> <span class="st">'/home/Shared/apsimx_env_data/apsimx_i_soil_ssurgo_profile.parquet'</span>,</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    met_path    <span class="op">=</span> <span class="st">'/home/Shared/apsimx_env_data/apsimx_i_soil_POWER_met.parquet'</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co"># restrict to simulated cultivars with the maximum MaximumGrainsPerCob</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> (x.Genotypes[<span class="st">'Grain.MaximumGrainsPerCob.FixedValue'</span>] <span class="op">==</span> x.Genotypes[<span class="st">'Grain.MaximumGrainsPerCob.FixedValue'</span>].<span class="bu">max</span>())</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>x.apply_mask(table<span class="op">=</span><span class="st">'Genotypes'</span>, mask<span class="op">=</span>mask)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-17" class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> x.met_data</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>metadata <span class="op">=</span> [</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Longitude'</span>, </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Latitude'</span>, </span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'year'</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>metrics <span class="op">=</span> [</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'radn_MJ_div_m2_div_day'</span>,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'maxt_oC'</span>,</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'mint_oC'</span>,</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'rain_mm'</span>,</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'rh_pr'</span>,</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'windspeed_m_div_s'</span>,</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'tav'</span>,</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'amp'</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure that there are the expected number of values per group</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> m.loc[(m.day <span class="op">&lt;</span> <span class="dv">366</span>), ].sort_values(metadata).reset_index(drop <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> m.groupby(metadata<span class="op">+</span>[<span class="st">'day'</span>]).mean().reset_index()</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="co"># all groups have 365 obs?</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="va">False</span> <span class="kw">not</span> <span class="kw">in</span> (m.groupby(metadata).count().reset_index().loc[:, [<span class="st">'day'</span>]] <span class="op">==</span> <span class="dv">365</span>).values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-18" class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Demonstrate reshaping. We want to "fold" this table so that there is a site (lon/lat/year) axis, a day axis, and a metrics axis.</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co"># To demonstrate this we'll get the </span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>mn <span class="op">=</span> m.loc[:, metadata<span class="op">+</span>[<span class="st">'day'</span>]].to_numpy()</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>mn <span class="op">=</span> mn.reshape(<span class="op">-</span><span class="dv">1</span>,  <span class="co"># as many sites as are available</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>                <span class="dv">365</span>, <span class="co"># days</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>                <span class="dv">4</span>)   <span class="co"># metrics (in this case lon, lat, year, day)</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Here we</span><span class="ch">\'</span><span class="st">ll show that this reshape is working as expected by plotting the "day" column across several sites'</span>)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>px.imshow(</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    np.concatenate([</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>        mn[i, <span class="dv">0</span>:<span class="dv">10</span>, <span class="dv">3</span>:]</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    ], axis <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-19" class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> x.met_data</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>metadata <span class="op">=</span> [</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Longitude'</span>, </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Latitude'</span>, </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'year'</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>metrics <span class="op">=</span> [</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'radn_MJ_div_m2_div_day'</span>,</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'maxt_oC'</span>,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'mint_oC'</span>,</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'rain_mm'</span>,</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'rh_pr'</span>,</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'windspeed_m_div_s'</span>,</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'tav'</span>,</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'amp'</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure that there are the expected number of values per group</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> m.loc[(m.day <span class="op">&lt;</span> <span class="dv">366</span>), ].sort_values(metadata).reset_index(drop <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> m.groupby(metadata<span class="op">+</span>[<span class="st">'day'</span>]).mean().reset_index()</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a><span class="co"># all groups have 365 obs?</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="va">False</span> <span class="kw">not</span> <span class="kw">in</span> (m.groupby(metadata).count().reset_index().loc[:, [<span class="st">'day'</span>]] <span class="op">==</span> <span class="dv">365</span>).values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-20" class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> m.loc[:, metrics</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    ].to_numpy(</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    ).reshape(</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span><span class="dv">1</span>,           <span class="co"># as many sites as are available</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>        <span class="dv">365</span>,          <span class="co"># days</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">len</span>(metrics)) <span class="co"># metrics</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>m[<span class="dv">0</span>, <span class="dv">0</span>:<span class="dv">5</span>, :]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-21" class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># let's also allow for an operations string so that we can _request_ data in a specific format instead of changing it after the fact.</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>ops_string <span class="op">=</span> <span class="st">'s d m -&gt; s m d'</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>ops <span class="op">=</span> ops_string.replace(<span class="st">' '</span>, <span class="st">''</span>).split(<span class="st">'-&gt;'</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>dim_order <span class="op">=</span> [i</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span> e <span class="kw">in</span> ops[<span class="dv">1</span>]</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(ops[<span class="dv">0</span>]))</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span> e <span class="op">==</span> ops[<span class="dv">0</span>][i]</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a> ]</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>m.shape, einops.rearrange(m, ops_string).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-22" class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>ref <span class="op">=</span> {</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'lookup_names'</span>: metadata,</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'data_names'</span>: metrics,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'data_dims'</span>: [[<span class="st">'site'</span>, <span class="st">'days'</span>, <span class="st">'metrics'</span>][i] <span class="cf">for</span> i <span class="kw">in</span> dim_order] <span class="co"># use the ops string to figure out the order that will be returned</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co"># to help avoid confustion later, we'll return some reference information too</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co"># (lookup, m, ref)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-26" class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># self.ssurgo_data = self.ssurgo_data.reset_index(drop = True)</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> x.ssurgo_data</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>metadata <span class="op">=</span> [</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'SoilIdx'</span>,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>metrics <span class="op">=</span> [</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'BD'</span>,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'AirDry'</span>,</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'LL15'</span>,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'DUL'</span>,</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'SAT'</span>,</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'KS'</span>,</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Carbon'</span>,</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'SoilCNRatio'</span>,</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'FOM'</span>,</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">'FOM.CN'</span>,</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">'FBiom'</span>,</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">'FInert'</span>,</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">'NO3N'</span>,</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">'NH4N'</span>,</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">'PH'</span>,</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ParticleSizeClay'</span>,</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ParticleSizeSilt'</span>,</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ParticleSizeSand'</span>,</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Maize.KL'</span>,</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Maize.LL'</span>,</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Maize.XF'</span>,</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 'Soybean.KL',</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 'Soybean.LL',</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 'Soybean.XF',</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 'Wheat.KL',</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 'Wheat.LL',</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 'Wheat.XF'</span></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>s.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-27" class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check that the soil slices are equally sized</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">len</span>(s.Thickness.unique()) <span class="op">==</span> <span class="dv">1</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Soil compartment thickness: </span><span class="sc">{</span>s<span class="sc">.</span>Thickness[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-28" class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check that there are an equal number of slices</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>_  <span class="op">=</span> s.loc[:, [<span class="st">'SoilIdx'</span>, <span class="st">'Thickness'</span>]].groupby([<span class="st">'SoilIdx'</span>]).count().reset_index()</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> _.Thickness.<span class="bu">min</span>() <span class="op">==</span> _.Thickness.<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-29" class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># turn range into start of slice</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>s[<span class="st">'Depth'</span>] <span class="op">=</span> s[<span class="st">'Depth'</span>].<span class="bu">str</span>.split(pat <span class="op">=</span> <span class="st">'-'</span>, expand <span class="op">=</span> <span class="va">True</span>)[<span class="dv">0</span>].astype(<span class="bu">int</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-30" class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> s.sort_values([<span class="st">'SoilIdx'</span>, <span class="st">'Depth'</span>]).reset_index(drop <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>lookup <span class="op">=</span> s.loc[:, metadata].drop_duplicates().to_numpy()</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> s.loc[:, metrics].to_numpy()</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> s.reshape(<span class="op">-</span><span class="dv">1</span>, lookup.shape[<span class="dv">0</span>], <span class="bu">len</span>(metrics))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-31" class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>ref <span class="op">=</span> {</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'lookup_names'</span>: metadata,</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'data_names'</span>: metrics,</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'data_dims'</span>: (<span class="st">'site'</span>, <span class="st">'depth'</span>, <span class="st">'metrics'</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co"># to help avoid confustion later, we'll return some reference information too</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co"># (lookup, s, ref)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-33" class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># self.Genotypes   = self.Genotypes.reset_index(  drop = True)</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> x.Genotypes</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Genotypes are easy to deal with because the table is cleaned up in filtering results. </span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>g.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-34" class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>metadata <span class="op">=</span> [</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'File'</span>,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Genotype'</span>,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>metrics <span class="op">=</span> [</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Grain.MaximumGrainsPerCob.FixedValue'</span>,</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Grain.MaximumPotentialGrainSize.FixedValue'</span>,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Phenology.FlagLeafToFlowering.Target.FixedValue'</span>,</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Phenology.FloweringToGrainFilling.Target.FixedValue'</span>,</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Phenology.GrainFilling.Target.FixedValue'</span>,</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Phenology.Juvenile.Target.FixedValue'</span>,</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Phenology.Maturing.Target.FixedValue'</span>,</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Phenology.MaturityToHarvestRipe.Target.FixedValue'</span>,</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Phenology.Photosensitive.Target.XYPairs.X__1'</span>,</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Phenology.Photosensitive.Target.XYPairs.X__2'</span>,</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Phenology.Photosensitive.Target.XYPairs.X__3'</span>,</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Phenology.Photosensitive.Target.XYPairs.Y__1'</span>,</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Phenology.Photosensitive.Target.XYPairs.Y__2'</span>,</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Phenology.Photosensitive.Target.XYPairs.Y__3'</span>,</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Rachis.DMDemands.Structural.DMDemandFunction.MaximumOrganWt.FixedValue'</span>,</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-35" class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>ref <span class="op">=</span> {</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'lookup_names'</span>: metadata,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'data_names'</span>: metrics,</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'data_dims'</span>: (<span class="st">'genotype'</span>, <span class="st">'metrics'</span>)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="co"># (g.loc[:, metadata].to_numpy(), g.loc[:, metrics].to_numpy(), ref)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-38" class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Example of Internals:</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="masking-genotypes" class="level3">
<h3 class="anchored" data-anchor-id="masking-genotypes">Masking genotypes</h3>
<p>The goal here is to not reinvent the wheel but to make certain tasks easier. We’re storing several tables as pandas dataframes we can lean on pandas to filter the data. Filters should be applied to multiple tables so we’ll automate that part to avoid forgetting to do it. The work flow will be 1. Access a dataframe and generate a mask 2. Use a helper function to apply the mask 1. The helper function will filter the specified dataframe (Ids or Genotypes) 1. The helper will then use the filtered dataframe to filter the other one keeping them both in sync.</p>
<div id="cell-40" class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now let's select a region of the country. For this demonstration I'll filter to a region around Columbia MO.</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> ((x.Ids.Longitude <span class="op">&lt;</span> <span class="op">-</span><span class="dv">90</span>) <span class="op">&amp;</span> </span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>        (x.Ids.Longitude <span class="op">&gt;</span> <span class="op">-</span><span class="dv">95</span>) <span class="op">&amp;</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>        (x.Ids.Latitude  <span class="op">&lt;</span>  <span class="dv">40</span>) <span class="op">&amp;</span> </span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>        (x.Ids.Latitude  <span class="op">&gt;</span>  <span class="dv">30</span>) </span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Before Mask: Genotypes: </span><span class="sc">{</span>x<span class="sc">.</span>Genotypes<span class="sc">.</span>shape<span class="sc">}</span><span class="ss"> Ids: </span><span class="sc">{</span>x<span class="sc">.</span>Ids<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>x.apply_mask(table<span class="op">=</span><span class="st">'Ids'</span>, mask<span class="op">=</span>mask)</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'After Mask: Genotypes: </span><span class="sc">{</span>x<span class="sc">.</span>Genotypes<span class="sc">.</span>shape<span class="sc">}</span><span class="ss"> Ids: </span><span class="sc">{</span>x<span class="sc">.</span>Ids<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-41" class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>x.Genotypes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="loading-results-tables" class="level3">
<h3 class="anchored" data-anchor-id="loading-results-tables">Loading Results tables</h3>
<p>The simulation results are spread across ~134 parquet files. This reduces the data storage needs but makes it harder to work with the files (than having one file per simulation or a fully fledged database server). To make the process of loading data faster, we find all the unique parquet files to be read (we might want multiple simulations from one file) and then read them in turn. Furthermore, we might only want to use a subset of years so we’ll allow for this to be specified.</p>
<div id="cell-43" class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>x.load_results(years <span class="op">=</span> [<span class="dv">1990</span>, <span class="dv">2000</span>, <span class="dv">2010</span>, <span class="dv">2020</span>], dry_run <span class="op">=</span> <span class="va">True</span>) <span class="co"># years is optional. If an empty list is passed all years will be returned.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-44" class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>x.load_results(years <span class="op">=</span> [<span class="dv">1990</span>, <span class="dv">2000</span>, <span class="dv">2010</span>, <span class="dv">2020</span>], dry_run <span class="op">=</span> <span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-45" class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># now results can be accessed </span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>x.results.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-46" class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>x.results.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-47" class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co">### Remove run-on simulation results and return each year's results</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-48" class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Turn results into tensor</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert unix date to year/doy</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>tmp <span class="op">=</span> x.results.merge(_prep_unix_epoch_to_date(max_year <span class="op">=</span> <span class="dv">2025</span>).loc[:, [<span class="st">'Unix'</span>, <span class="st">'Year'</span>, <span class="st">'DOY'</span>]].rename(columns<span class="op">=</span>{<span class="st">'Unix'</span>:<span class="st">'Date'</span>}))</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>tmp.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="masking-genotypes-1" class="level3">
<h3 class="anchored" data-anchor-id="masking-genotypes-1">Masking genotypes</h3>
<p>The goal here is to not reinvent the wheel but to make certain tasks easier. We’re storing several tables as pandas dataframes we can lean on pandas to filter the data. Filters should be applied to multiple tables so we’ll automate that part to avoid forgetting to do it. The work flow will be 1. Access a dataframe and generate a mask 2. Use a helper function to apply the mask 1. The helper function will filter the specified dataframe (Ids or Genotypes) 1. The helper will then use the filtered dataframe to filter the other one keeping them both in sync.</p>
<div id="cell-50" class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now let's select a region of the country. For this demonstration I'll filter to a region around Columbia MO.</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> ((x.Ids.Longitude <span class="op">&lt;</span> <span class="op">-</span><span class="dv">90</span>) <span class="op">&amp;</span> </span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>        (x.Ids.Longitude <span class="op">&gt;</span> <span class="op">-</span><span class="dv">95</span>) <span class="op">&amp;</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>        (x.Ids.Latitude  <span class="op">&lt;</span>  <span class="dv">40</span>) <span class="op">&amp;</span> </span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>        (x.Ids.Latitude  <span class="op">&gt;</span>  <span class="dv">30</span>) </span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Before Mask: Genotypes: </span><span class="sc">{</span>x<span class="sc">.</span>Genotypes<span class="sc">.</span>shape<span class="sc">}</span><span class="ss"> Ids: </span><span class="sc">{</span>x<span class="sc">.</span>Ids<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>x.apply_mask(table<span class="op">=</span><span class="st">'Ids'</span>, mask<span class="op">=</span>mask)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'After Mask: Genotypes: </span><span class="sc">{</span>x<span class="sc">.</span>Genotypes<span class="sc">.</span>shape<span class="sc">}</span><span class="ss"> Ids: </span><span class="sc">{</span>x<span class="sc">.</span>Ids<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-51" class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>x.Genotypes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="loading-results-tables-1" class="level3">
<h3 class="anchored" data-anchor-id="loading-results-tables-1">Loading Results tables</h3>
<p>The simulation results are spread across ~134 parquet files. This reduces the data storage needs but makes it harder to work with the files (than having one file per simulation or a fully fledged database server). To make the process of loading data faster, we find all the unique parquet files to be read (we might want multiple simulations from one file) and then read them in turn. Furthermore, we might only want to use a subset of years so we’ll allow for this to be specified.</p>
<div id="cell-53" class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>x.load_results(years <span class="op">=</span> [<span class="dv">1990</span>, <span class="dv">2000</span>, <span class="dv">2010</span>, <span class="dv">2020</span>], dry_run <span class="op">=</span> <span class="va">True</span>) <span class="co"># years is optional. If an empty list is passed all years will be returned.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-54" class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>x.load_results(years <span class="op">=</span> [<span class="dv">1990</span>, <span class="dv">2000</span>, <span class="dv">2010</span>, <span class="dv">2020</span>], dry_run <span class="op">=</span> <span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-55" class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># now results can be accessed </span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>x.results.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-56" class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>x.results.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="remove-run-on-simulation-results-and-return-each-years-results" class="level3">
<h3 class="anchored" data-anchor-id="remove-run-on-simulation-results-and-return-each-years-results">Remove run-on simulation results and return each year’s results</h3>
<div id="cell-58" class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Turn results into tensor</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert unix date to year/doy</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>tmp <span class="op">=</span> x.results.merge(_prep_unix_epoch_to_date(max_year <span class="op">=</span> <span class="dv">2025</span>).loc[:, [<span class="st">'Unix'</span>, <span class="st">'Year'</span>, <span class="st">'DOY'</span>]].rename(columns<span class="op">=</span>{<span class="st">'Unix'</span>:<span class="st">'Date'</span>}))</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>tmp.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-59" class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure we don't allow for observations to cross over two years</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="co"># tmp2 = tmp.loc[:, ['FactorialUID', 'Year']].drop_duplicates()</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>tmp.loc[tmp.FactorialUID <span class="op">==</span> <span class="dv">14689</span>, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-60" class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> tmp.loc[tmp.FactorialUID <span class="op">==</span> <span class="dv">14689</span>, ]</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>plt.scatter(x <span class="op">=</span> _.DOY, y <span class="op">=</span> _[<span class="st">'Maize.AboveGround.Wt'</span>])</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="co"># some of these run into the subsequent year. To deal with this...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-61" class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># find the smallest above ground weight within each year, usethat to get the first date within eacy year and then filter for the values that are &gt;= the within year start.</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> tmp.loc[:, [<span class="st">'FactorialUID'</span>, <span class="st">'Year'</span>, <span class="st">'Maize.AboveGround.Wt'</span>]].groupby([<span class="st">'FactorialUID'</span>, <span class="st">'Year'</span>]).agg(<span class="st">'min'</span>).reset_index()</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> _.merge(tmp).loc[:, [<span class="st">'FactorialUID'</span>, <span class="st">'Year'</span>, <span class="st">'Date'</span>]].rename(columns<span class="op">=</span>{<span class="st">'Date'</span>: <span class="st">'YearStart'</span>})</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>tmp <span class="op">=</span> tmp.merge(_, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>tmp.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-62" class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Retained values</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> tmp.loc[((tmp.FactorialUID <span class="op">==</span> <span class="dv">14689</span>) <span class="op">&amp;</span> </span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>             (tmp.Date <span class="op">&gt;=</span> tmp.YearStart)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>             ), ]</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>plt.scatter(x <span class="op">=</span> _.DOY, y <span class="op">=</span> _[<span class="st">'Maize.AboveGround.Wt'</span>])</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> tmp.loc[((tmp.FactorialUID <span class="op">==</span> <span class="dv">14689</span>) <span class="op">&amp;</span> </span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>             (tmp.Date <span class="op">&lt;</span> tmp.YearStart)</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>             ), ]</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>plt.scatter(x <span class="op">=</span> _.DOY, y <span class="op">=</span> _[<span class="st">'Maize.AboveGround.Wt'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-63" class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Turn results into tensor</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>tmp <span class="op">=</span> x.results.merge(_prep_unix_epoch_to_date(max_year <span class="op">=</span> <span class="dv">2025</span>).loc[:, [<span class="st">'Unix'</span>, <span class="st">'Year'</span>, <span class="st">'DOY'</span>]].rename(columns<span class="op">=</span>{<span class="st">'Unix'</span>:<span class="st">'Date'</span>}))</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co"># find the smallest above ground weight within each year, usethat to get the first date within eacy year and then filter for the values that are &gt;= the within year start.</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> tmp.loc[:, [<span class="st">'FactorialUID'</span>, <span class="st">'Year'</span>, <span class="st">'Maize.AboveGround.Wt'</span>]].groupby([<span class="st">'FactorialUID'</span>, <span class="st">'Year'</span>]).agg(<span class="st">'min'</span>).reset_index()</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> _.merge(tmp).loc[:, [<span class="st">'FactorialUID'</span>, <span class="st">'Year'</span>, <span class="st">'Date'</span>]].rename(columns<span class="op">=</span>{<span class="st">'Date'</span>: <span class="st">'YearStart'</span>})</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>tmp <span class="op">=</span> tmp.merge(_, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>tmp <span class="op">=</span> tmp.loc[(tmp.Date <span class="op">&gt;=</span> tmp.YearStart), ]</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>tmp<span class="op">=</span>tmp.drop(columns<span class="op">=</span>[<span class="st">'YearStart'</span>, <span class="st">'Date'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-64" class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>tmp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-65" class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># if making point estimates:</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>tmp.drop(columns<span class="op">=</span><span class="st">'DOY'</span>).groupby([<span class="st">'FactorialUID'</span>, <span class="st">'Year'</span>]).agg(<span class="st">'max'</span>).reset_index()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-66" class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>tmp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-67" class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> (</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    (tmp.FactorialUID <span class="op">==</span> <span class="dv">11811</span>) <span class="op">&amp;</span> </span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    (tmp.Year <span class="op">==</span> <span class="dv">1990</span>))</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>min_doy, max_doy <span class="op">=</span> tmp.loc[mask, <span class="st">'DOY'</span>].agg((<span class="st">'min'</span>, <span class="st">'max'</span>)).values</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>out <span class="op">=</span> torch.zeros(<span class="dv">365</span>, <span class="dv">3</span>)</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>out[min_doy:(max_doy<span class="op">+</span><span class="dv">1</span>), ] <span class="op">=</span> torch.tensor(tmp.loc[mask, [<span class="st">'Maize.AboveGround.Wt'</span>, <span class="st">'Maize.LAI'</span>, <span class="st">'yield_Kgha'</span>]].to_numpy())</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a><span class="co"># propagate forward observations to all dates following the max</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>out[max_doy:<span class="dv">365</span>, ] <span class="op">=</span> out[max_doy, ]</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>plt.scatter(x <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">365</span>, <span class="dv">365</span>), y <span class="op">=</span> out[:, <span class="dv">2</span>].numpy())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-68" class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>x.results_as_arrays(output_type <span class="op">=</span> <span class="st">'point'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-69" class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>x.results_as_arrays(output_type <span class="op">=</span> <span class="st">'sequence'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-70" class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co">#TODO write a method to return the </span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="co"># - cultivar information </span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="co"># - planting date as DOY</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="co"># - lookup(s)</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="co">#TODO work with the environmental data</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="co"># - reduce columns</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="co"># - create easy lookup</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="clean-up-environmental-data" class="level2">
<h2 class="anchored" data-anchor-id="clean-up-environmental-data">Clean up Environmental Data</h2>
<div id="cell-72" class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>env_path <span class="op">=</span> <span class="st">'/home/Shared/apsimx_env_data'</span><span class="op">+</span><span class="st">'/'</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ./apsimx_i_soil_ssurgo_profile.parquet</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="co"># met files (easy to parse)</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="co"># env_path+'apsimx_i_soil_POWER_met.parquet'</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>lookup <span class="op">=</span> pq.read_table(env_path<span class="op">+</span><span class="st">'apsimx_i_soil_gps.parquet'</span>).to_pandas()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-73" class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load env data</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>met_data <span class="op">=</span> pq.read_table(env_path<span class="op">+</span><span class="st">'apsimx_i_soil_POWER_met.parquet'</span>).to_pandas().rename(columns <span class="op">=</span> {<span class="st">'latitude'</span>:<span class="st">'Latitude'</span>, </span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>                                                                                                   <span class="st">'longitude'</span>: <span class="st">'Longitude'</span>})</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>met_data</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>ssurgo_data <span class="op">=</span> pq.read_table(env_path<span class="op">+</span><span class="st">'apsimx_i_soil_ssurgo_profile.parquet'</span>).to_pandas().rename(columns <span class="op">=</span> {<span class="st">'soil_i'</span>:<span class="st">'SoilIdx'</span>})</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>ssurgo_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-74" class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># shared soilIdx</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>Ids_idxs <span class="op">=</span> x.Ids.loc[:, [<span class="st">'Longitude'</span>, <span class="st">'Latitude'</span>, <span class="st">'SoilIdx'</span>]].drop_duplicates()</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>ssurgo_s <span class="op">=</span> ssurgo_data.loc[:, [<span class="st">'SoilIdx'</span>]].drop_duplicates()</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>met_lonlat <span class="op">=</span> met_data.loc[:, [<span class="st">'Longitude'</span>, <span class="st">'Latitude'</span>]].drop_duplicates()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-75" class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Uniq. Lon/Lat/Soil: </span><span class="sc">{</span>Ids_idxs<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Condition on data availability:'</span>)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>Ids_idxs <span class="op">=</span> Ids_idxs.merge(ssurgo_s, how <span class="op">=</span> <span class="st">'inner'</span>).merge(met_lonlat, how <span class="op">=</span> <span class="st">'inner'</span>)</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Uniq. Lon/Lat/Soil: </span><span class="sc">{</span>Ids_idxs<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-76" class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># reduce the environmental datasets:</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>met_data    <span class="op">=</span> Ids_idxs.drop(columns<span class="op">=</span>[<span class="st">'SoilIdx'</span>]).drop_duplicates().merge(met_lonlat, how <span class="op">=</span> <span class="st">'inner'</span>)</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>ssurgo_data <span class="op">=</span> Ids_idxs.drop(columns<span class="op">=</span>[<span class="st">'Longitude'</span>, <span class="st">'Latitude'</span>]).drop_duplicates().merge(ssurgo_data, how <span class="op">=</span> <span class="st">'inner'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-77" class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># update Ids &amp; results:</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>x.Ids <span class="op">=</span> Ids_idxs.merge(x.Ids)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> x.Ids.loc[:, [<span class="st">'FactorialUID'</span>]].drop_duplicates()</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>x.results <span class="op">=</span> _.merge(x.results, how<span class="op">=</span><span class="st">'inner'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-80" class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>Ids_s    <span class="op">=</span> x.Ids.loc[:, [<span class="st">'SoilIdx'</span>]].drop_duplicates()</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>x.Ids</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-81" class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>Ids</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-82" class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># using inner join here to make sure there aren't any indexes in the results that we don't have environmental data for</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>ssurgo_data.merge(Ids_s, how<span class="op">=</span><span class="st">'inner'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-83" class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>Ids_s.merge(ssurgo_data, how<span class="op">=</span><span class="st">'inner'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="physical-properties" class="level3">
<h3 class="anchored" data-anchor-id="physical-properties">Physical Properties</h3>
<div id="cell-87" class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>env_tables <span class="op">=</span> [</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'apsimx_i_soil_Soils_CERESSoilTemperature.parquet'</span>,</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'apsimx_i_soil_Soils_Chemical.parquet'</span>,</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'apsimx_i_soil_Soils_Nutrients.Nutrient.parquet'</span>,</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'apsimx_i_soil_Soils_Organic.parquet'</span>,</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'apsimx_i_soil_Soils_Physical.parquet'</span>,</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'apsimx_i_soil_Soils_Soil.parquet'</span>,</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'apsimx_i_soil_Soils_Solute.parquet'</span>,</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'apsimx_i_soil_Soils_Water.parquet'</span>,</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'apsimx_i_soil_WaterModel_WaterBalance.parquet'</span>]</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>soil_dict <span class="op">=</span> {e:pq.read_table(env_path<span class="op">+</span>e).to_pandas() <span class="cf">for</span> e <span class="kw">in</span> env_tables}<span class="co">#[env_tables[1]]</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a><span class="co"># focus on only one entry</span></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>soil_dict <span class="op">=</span> {k:soil_dict[k].loc[(soil_dict[k].list_idx <span class="op">==</span> <span class="dv">1</span>), ] <span class="cf">for</span> k <span class="kw">in</span> env_tables}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-88" class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="bu">sorted</span>(<span class="bu">list</span>(<span class="bu">set</span>(<span class="bu">sum</span>([<span class="bu">list</span>(pq.read_table(env_path<span class="op">+</span>e).to_pandas()) <span class="cf">for</span> e <span class="kw">in</span> env_tables], []))))</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="co"># problem: There are some columns that just don't look like they are saved in the data. E.g. soil/Physical.`maize LL` </span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>[<span class="st">'$type'</span>,</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a> <span class="st">'AirDry'</span>,</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a> <span class="st">'AirDryMetadata'</span>,</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a> <span class="st">'ApsoilNumber'</span>,</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a> <span class="st">'BD'</span>,</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a> <span class="st">'BDMetadata'</span>,</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a> <span class="st">'CN2Bare'</span>,</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a> <span class="st">'CNCov'</span>,</span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a> <span class="st">'CNRed'</span>,</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a> <span class="st">'Carbon'</span>,</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a> <span class="st">'CarbonUnits'</span>,</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a> <span class="st">'CatchmentArea'</span>,</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a> <span class="st">'Comments'</span>,</span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a> <span class="st">'Country'</span>,</span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a> <span class="st">'D0'</span>,</span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a> <span class="st">'DUL'</span>,</span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a> <span class="st">'DULMetadata'</span>,</span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a> <span class="st">'DataSource'</span>,</span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a> <span class="st">'DepthConstant'</span>,</span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a> <span class="st">'DiffusConst'</span>,</span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a> <span class="st">'DiffusSlope'</span>,</span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a> <span class="st">'DischargeWidth'</span>,</span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a> <span class="st">'Enabled'</span>,</span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a> <span class="st">'Exco'</span>,</span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true" tabindex="-1"></a> <span class="st">'FBiom'</span>,</span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true" tabindex="-1"></a> <span class="st">'FIP'</span>,</span>
<span id="cb73-31"><a href="#cb73-31" aria-hidden="true" tabindex="-1"></a> <span class="st">'FInert'</span>,</span>
<span id="cb73-32"><a href="#cb73-32" aria-hidden="true" tabindex="-1"></a> <span class="st">'FOM'</span>,</span>
<span id="cb73-33"><a href="#cb73-33" aria-hidden="true" tabindex="-1"></a> <span class="st">'FOMCNRatio'</span>,</span>
<span id="cb73-34"><a href="#cb73-34" aria-hidden="true" tabindex="-1"></a> <span class="st">'FilledFromTop'</span>,</span>
<span id="cb73-35"><a href="#cb73-35" aria-hidden="true" tabindex="-1"></a> <span class="st">'InitialPAWmm'</span>,</span>
<span id="cb73-36"><a href="#cb73-36" aria-hidden="true" tabindex="-1"></a> <span class="st">'InitialValues'</span>,</span>
<span id="cb73-37"><a href="#cb73-37" aria-hidden="true" tabindex="-1"></a> <span class="st">'InitialValuesUnits'</span>,</span>
<span id="cb73-38"><a href="#cb73-38" aria-hidden="true" tabindex="-1"></a> <span class="st">'KS'</span>,</span>
<span id="cb73-39"><a href="#cb73-39" aria-hidden="true" tabindex="-1"></a> <span class="st">'LL15'</span>,</span>
<span id="cb73-40"><a href="#cb73-40" aria-hidden="true" tabindex="-1"></a> <span class="st">'LL15Metadata'</span>,</span>
<span id="cb73-41"><a href="#cb73-41" aria-hidden="true" tabindex="-1"></a> <span class="st">'Latitude'</span>,</span>
<span id="cb73-42"><a href="#cb73-42" aria-hidden="true" tabindex="-1"></a> <span class="st">'Longitude'</span>,</span>
<span id="cb73-43"><a href="#cb73-43" aria-hidden="true" tabindex="-1"></a> <span class="st">'MaxDepthSoluteAccessible'</span>,</span>
<span id="cb73-44"><a href="#cb73-44" aria-hidden="true" tabindex="-1"></a> <span class="st">'MaxEffectiveRunoff'</span>,</span>
<span id="cb73-45"><a href="#cb73-45" aria-hidden="true" tabindex="-1"></a> <span class="st">'Name'</span>,</span>
<span id="cb73-46"><a href="#cb73-46" aria-hidden="true" tabindex="-1"></a> <span class="st">'PH'</span>,</span>
<span id="cb73-47"><a href="#cb73-47" aria-hidden="true" tabindex="-1"></a> <span class="st">'PHMetadata'</span>,</span>
<span id="cb73-48"><a href="#cb73-48" aria-hidden="true" tabindex="-1"></a> <span class="st">'PHUnits'</span>,</span>
<span id="cb73-49"><a href="#cb73-49" aria-hidden="true" tabindex="-1"></a> <span class="st">'PSIDul'</span>,</span>
<span id="cb73-50"><a href="#cb73-50" aria-hidden="true" tabindex="-1"></a> <span class="st">'ParticleSizeClay'</span>,</span>
<span id="cb73-51"><a href="#cb73-51" aria-hidden="true" tabindex="-1"></a> <span class="st">'ParticleSizeSand'</span>,</span>
<span id="cb73-52"><a href="#cb73-52" aria-hidden="true" tabindex="-1"></a> <span class="st">'ParticleSizeSilt'</span>,</span>
<span id="cb73-53"><a href="#cb73-53" aria-hidden="true" tabindex="-1"></a> <span class="st">'ReadOnly'</span>,</span>
<span id="cb73-54"><a href="#cb73-54" aria-hidden="true" tabindex="-1"></a> <span class="st">'RecordNumber'</span>,</span>
<span id="cb73-55"><a href="#cb73-55" aria-hidden="true" tabindex="-1"></a> <span class="st">'Region'</span>,</span>
<span id="cb73-56"><a href="#cb73-56" aria-hidden="true" tabindex="-1"></a> <span class="st">'RelativeTo'</span>,</span>
<span id="cb73-57"><a href="#cb73-57" aria-hidden="true" tabindex="-1"></a> <span class="st">'ResourceName'</span>,</span>
<span id="cb73-58"><a href="#cb73-58" aria-hidden="true" tabindex="-1"></a> <span class="st">'RunoffEffectivenessAtMovingSolute'</span>,</span>
<span id="cb73-59"><a href="#cb73-59" aria-hidden="true" tabindex="-1"></a> <span class="st">'SAT'</span>,</span>
<span id="cb73-60"><a href="#cb73-60" aria-hidden="true" tabindex="-1"></a> <span class="st">'SATMetadata'</span>,</span>
<span id="cb73-61"><a href="#cb73-61" aria-hidden="true" tabindex="-1"></a> <span class="st">'SWCON'</span>,</span>
<span id="cb73-62"><a href="#cb73-62" aria-hidden="true" tabindex="-1"></a> <span class="st">'Salb'</span>,</span>
<span id="cb73-63"><a href="#cb73-63" aria-hidden="true" tabindex="-1"></a> <span class="st">'SoilCNRatio'</span>,</span>
<span id="cb73-64"><a href="#cb73-64" aria-hidden="true" tabindex="-1"></a> <span class="st">'SoilType'</span>,</span>
<span id="cb73-65"><a href="#cb73-65" aria-hidden="true" tabindex="-1"></a> <span class="st">'State'</span>,</span>
<span id="cb73-66"><a href="#cb73-66" aria-hidden="true" tabindex="-1"></a> <span class="st">'SummerCona'</span>,</span>
<span id="cb73-67"><a href="#cb73-67" aria-hidden="true" tabindex="-1"></a> <span class="st">'SummerDate'</span>,</span>
<span id="cb73-68"><a href="#cb73-68" aria-hidden="true" tabindex="-1"></a> <span class="st">'SummerU'</span>,</span>
<span id="cb73-69"><a href="#cb73-69" aria-hidden="true" tabindex="-1"></a> <span class="st">'Thickness'</span>,</span>
<span id="cb73-70"><a href="#cb73-70" aria-hidden="true" tabindex="-1"></a> <span class="st">'WaterTableConcentration'</span>,</span>
<span id="cb73-71"><a href="#cb73-71" aria-hidden="true" tabindex="-1"></a> <span class="st">'WinterCona'</span>,</span>
<span id="cb73-72"><a href="#cb73-72" aria-hidden="true" tabindex="-1"></a> <span class="st">'WinterDate'</span>,</span>
<span id="cb73-73"><a href="#cb73-73" aria-hidden="true" tabindex="-1"></a> <span class="st">'WinterU'</span>,</span>
<span id="cb73-74"><a href="#cb73-74" aria-hidden="true" tabindex="-1"></a> <span class="st">'YearOfSampling'</span>,</span>
<span id="cb73-75"><a href="#cb73-75" aria-hidden="true" tabindex="-1"></a> <span class="st">'list_idx'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-89" class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>soil_dict[<span class="st">'apsimx_i_soil_Soils_Physical.parquet'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-90" class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># table to cols:</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>desired_fields <span class="op">=</span> {</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 'apsimx_i_soil_Soils_CERESSoilTemperature.parquet': [],</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="st">'apsimx_i_soil_Soils_Chemical.parquet'</span>: [<span class="st">'Thickness'</span>, <span class="st">'PH'</span>],</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 'apsimx_i_soil_Soils_Nutrients.Nutrient.parquet': [],</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="st">'apsimx_i_soil_Soils_Organic.parquet'</span>: [<span class="st">'Thickness'</span>, <span class="st">'Carbon'</span>, <span class="st">'SoilCNRatio'</span>, <span class="st">'FBiom'</span>, <span class="st">'FInert'</span>, <span class="st">'FOM'</span>, <span class="st">'FOMCNRatio'</span>, <span class="st">'CarbonUnits'</span>],</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a><span class="st">'apsimx_i_soil_Soils_Physical.parquet'</span>: [<span class="st">'Thickness'</span>, <span class="st">'ParticleSizeClay'</span>, <span class="st">'ParticleSizeSand'</span>, <span class="st">'ParticleSizeSilt'</span>, <span class="st">'BD'</span>, <span class="st">'AirDry'</span>, <span class="st">'LL15'</span>, <span class="st">'DUL'</span>, <span class="st">'SAT'</span>],</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 'apsimx_i_soil_Soils_Soil.parquet': [],</span></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 'apsimx_i_soil_Soils_Solute.parquet': [],</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a><span class="st">'apsimx_i_soil_Soils_Water.parquet'</span>: [<span class="st">'Thickness'</span>, <span class="st">'InitialValues'</span>, <span class="st">'InitialPAWmm'</span>, <span class="st">'RelativeTo'</span>],</span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a><span class="st">'apsimx_i_soil_WaterModel_WaterBalance.parquet'</span>: [<span class="st">'Thickness'</span>, <span class="st">'SWCON'</span>]</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-91" class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> [soil_dict[k].loc[:, desired_fields[k]] <span class="cf">for</span> i, k <span class="kw">in</span> <span class="bu">enumerate</span>(desired_fields)]</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="co"># pd.merge( res[1])</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>res[<span class="dv">0</span>]</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>res[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-92" class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>soil_dict[env_tables[<span class="dv">1</span>]]    </span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>soil_dict[env_tables[<span class="dv">3</span>]]    </span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="co"># soil_dict['apsimx_i_soil_Soils_CERESSoilTemperature.parquet']</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>soil_dict[<span class="st">'apsimx_i_soil_Soils_Chemical.parquet'</span>] <span class="co"># Thickness   PH </span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a><span class="co"># soil_dict['apsimx_i_soil_Soils_Nutrients.Nutrient.parquet']</span></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>soil_dict[<span class="st">'apsimx_i_soil_Soils_Organic.parquet'</span>] <span class="co">#Thickness Carbon  SoilCNRatio FBiom   FInert  FOM $type   FOMCNRatio  CarbonUnits</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>soil_dict[<span class="st">'apsimx_i_soil_Soils_Physical.parquet'</span>] <span class="co">#     Thickness   ParticleSizeClay    ParticleSizeSand    ParticleSizeSilt    BD  AirDry  LL15    DUL SAT </span></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a><span class="co"># soil_dict['apsimx_i_soil_Soils_Soil.parquet'] # contains metadata</span></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a><span class="co"># soil_dict['apsimx_i_soil_Soils_Solute.parquet'] # # Maybe useful, but it dosn't look like it? Thickness   InitialValues   Exco    FIP     InitialValuesUnits  WaterTableConcentration D0  DepthConstant   MaxDepthSoluteAccessible    RunoffEffectivenessAtMovingSolute   MaxEffectiveRunoff  Name</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>soil_dict[<span class="st">'apsimx_i_soil_Soils_Water.parquet'</span>] <span class="co"># Thickness  InitialValues   $type   InitialPAWmm    RelativeTo</span></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>soil_dict[<span class="st">'apsimx_i_soil_WaterModel_WaterBalance.parquet'</span>] <span class="co">#    Thickness   SWCON</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-93" class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Depth Thickness   BD  AirDry  LL15    DUL SAT KS  Carbon  SoilCNRatio FOM FOM.CN  FBiom   FInert  NO3N    NH4N    PH  ParticleSizeClay    ParticleSizeSilt    ParticleSizeSand    Maize.KL    Maize.LL    Maize.XF    Soybean.KL  Soybean.LL  Soybean.XF  Wheat.KL    Wheat.LL    Wheat.XF</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="define-working-set" class="level2">
<h2 class="anchored" data-anchor-id="define-working-set">Define working set</h2>
<div id="cell-98" class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Starting with a location and year</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> px.scatter_mapbox(Ids.loc[:, [<span class="st">'Longitude'</span>, <span class="st">'Latitude'</span>]].drop_duplicates(), lon <span class="op">=</span> <span class="st">'Longitude'</span>, lat <span class="op">=</span> <span class="st">'Latitude'</span>,</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>                        color_discrete_sequence<span class="op">=</span>[<span class="st">"fuchsia"</span>], zoom<span class="op">=</span><span class="dv">3</span>, height<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>fig.update_layout(mapbox_style<span class="op">=</span><span class="st">"open-street-map"</span>)</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>fig.update_layout(margin<span class="op">=</span>{<span class="st">"r"</span>:<span class="dv">0</span>,<span class="st">"t"</span>:<span class="dv">0</span>,<span class="st">"l"</span>:<span class="dv">0</span>,<span class="st">"b"</span>:<span class="dv">0</span>})</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-99" class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; File   Genotype  --Genotypes-&gt; </span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="co">#    FactorialUID     --Results-&gt;</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>lon, lat, soil <span class="op">=</span> [<span class="op">-</span><span class="fl">76.65611874999999</span>, <span class="fl">42.733264</span>, <span class="dv">141</span>] <span class="co">#lon lat soil</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="co"># should allow ranges, slices, or all</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>sow <span class="op">=</span> <span class="st">'19-Jun'</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a><span class="co"># allow all</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>cultivar <span class="op">=</span> <span class="st">'Cultivar1'</span></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; File FactorialUID</span></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> (</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>    (Ids.Longitude <span class="op">==</span> lon) <span class="op">&amp;</span></span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>    (Ids.Latitude <span class="op">==</span> lat) <span class="op">&amp;</span></span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>    (Ids.SoilIdx <span class="op">==</span> soil) <span class="op">&amp;</span></span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>    (Ids.SowDate <span class="op">==</span> sow) <span class="op">&amp;</span></span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>    (Ids.Genotype <span class="op">==</span> cultivar))</span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a>Ids.loc[mask, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-101" class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Starting with a target set of genotypes</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> Genotypes[<span class="st">'Grain.MaximumGrainsPerCob.FixedValue'</span>] <span class="op">==</span> Genotypes[<span class="st">'Grain.MaximumGrainsPerCob.FixedValue'</span>].<span class="bu">max</span>()</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>Genotypes.loc[mask, [<span class="st">'File'</span>, <span class="st">'Genotype'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="convert-small-datasets-to-tensors" class="level2">
<h2 class="anchored" data-anchor-id="convert-small-datasets-to-tensors">Convert Small Datasets to Tensors</h2>
<section id="genotypes-cultivar-variables" class="level3">
<h3 class="anchored" data-anchor-id="genotypes-cultivar-variables"><code>Genotypes</code> (Cultivar variables)</h3>
<p>Warning! There are some NAs from Genotypes that are not “Cultivar” Genotypes. These are calibrated genotypes that with defaults that are not clear.</p>
<div id="cell-104" class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># keep as df or matrix (contains text)</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>Genotypes_lookup <span class="op">=</span> Genotypes.loc[:, [<span class="st">'File'</span>, <span class="st">'Genotype'</span>]].copy()</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ['Grain.MaximumGrainsPerCob.FixedValue',</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a><span class="co">#  'Grain.MaximumPotentialGrainSize.FixedValue',</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a><span class="co">#  'Phenology.FlagLeafToFlowering.Target.FixedValue',</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a><span class="co">#  'Phenology.FloweringToGrainFilling.Target.FixedValue',</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a><span class="co">#  'Phenology.GrainFilling.Target.FixedValue',</span></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a><span class="co">#  'Phenology.Juvenile.Target.FixedValue',</span></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a><span class="co">#  'Phenology.Maturing.Target.FixedValue',</span></span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a><span class="co">#  'Phenology.MaturityToHarvestRipe.Target.FixedValue',</span></span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a><span class="co">#  'Phenology.Photosensitive.Target.XYPairs.X__1',</span></span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a><span class="co">#  'Phenology.Photosensitive.Target.XYPairs.X__2',</span></span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a><span class="co">#  'Phenology.Photosensitive.Target.XYPairs.X__3',</span></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a><span class="co">#  'Phenology.Photosensitive.Target.XYPairs.Y__1',</span></span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a><span class="co">#  'Phenology.Photosensitive.Target.XYPairs.Y__2',</span></span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a><span class="co">#  'Phenology.Photosensitive.Target.XYPairs.Y__3',</span></span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a><span class="co">#  'Rachis.DMDemands.Structural.DMDemandFunction.MaximumOrganWt.FixedValue']</span></span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a>Genotypes_cols <span class="op">=</span> <span class="bu">list</span>(Genotypes)</span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a>Genotypes <span class="op">=</span> Genotypes.drop(columns<span class="op">=</span>[<span class="st">'File'</span>, <span class="st">'Genotype'</span>])</span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true" tabindex="-1"></a><span class="co"># coerce None to NaN so we can convert to matrix</span></span>
<span id="cb82-23"><a href="#cb82-23" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> e <span class="kw">in</span> <span class="bu">list</span>(Genotypes):</span>
<span id="cb82-24"><a href="#cb82-24" aria-hidden="true" tabindex="-1"></a>    Genotypes[e] <span class="op">=</span> Genotypes[e].astype(<span class="bu">float</span>)</span>
<span id="cb82-25"><a href="#cb82-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-26"><a href="#cb82-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Genotypes = torch.tensor(Genotypes.to_numpy())</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-105" class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>Genotypes_lookup</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-106" class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># for a given idx and year...</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>idx_Ids <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>year <span class="op">=</span> <span class="dv">2000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-107" class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get lookup information</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>lookup <span class="op">=</span> Ids.loc[idx_Ids, ].to_dict()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-108" class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> ((Genotypes_lookup.File <span class="op">==</span> lookup[<span class="st">'File'</span>]) <span class="op">&amp;</span>  (Genotypes_lookup.Genotype <span class="op">==</span> lookup[<span class="st">'Genotype'</span>]))</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="co"># should only have a single value</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">sum</span>(mask) <span class="op">==</span> <span class="dv">1</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>idx_Geno <span class="op">=</span> Genotypes_lookup.loc[mask, ].index[<span class="dv">0</span>]</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>Genotypes[idx_Geno]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-109" class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>lookup</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-110" class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>lookup_date <span class="op">=</span> _prep_unix_epoch_to_date(max_year <span class="op">=</span> <span class="dv">2024</span>)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>lookup_date.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-111" class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>Result <span class="op">=</span> pq.read_table(apsimx_sim_parquet_dir<span class="op">+</span><span class="st">'/'</span><span class="op">+</span><span class="st">'sim_1698440407_4739.parquet'</span>).to_pandas()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-112" class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># lookup_* is a internally generated ref</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="co"># *_lookup is a table based on loaded apsimx data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-113" class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>Result_lookup <span class="op">=</span> Result.loc[:, [<span class="st">'Date'</span>, <span class="st">'FactorialUID'</span>]].copy()</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>Result.drop(columns<span class="op">=</span>[<span class="st">'Date'</span>, <span class="st">'FactorialUID'</span>])</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>Result_list <span class="op">=</span> <span class="bu">list</span>(Result)</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>Result <span class="op">=</span> torch.tensor(Result.to_numpy())</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>Result_lookup.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-114" class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(Result_lookup.shape)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>Result_lookup.merge(lookup_date.rename(columns<span class="op">=</span>{<span class="st">'Unix'</span>:<span class="st">'Date'</span>}), how <span class="op">=</span> <span class="st">'left'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-115" class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>Result_lookup.loc[(Result_lookup.FactorialUID <span class="op">==</span> <span class="dv">24024</span>), ].merge(lookup_date.rename(columns<span class="op">=</span>{<span class="st">'Unix'</span>:<span class="st">'Date'</span>}), how <span class="op">=</span> <span class="st">'left'</span>).Date.<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-117" class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>((<span class="dv">19250</span><span class="op">-</span><span class="dv">5285</span>)<span class="op">/</span><span class="dv">365</span>)<span class="op">+</span><span class="dv">1984</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-118" class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>Genotypes_cols</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-119" class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>lookup</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-120" class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co"> make this valid for torch</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>sow_date <span class="op">=</span> lookup_date.loc[((lookup_date.Year <span class="op">==</span> year) <span class="op">&amp;</span> </span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>                            (lookup_date.SowDate <span class="op">==</span> lookup[<span class="st">'SowDate'</span>])), <span class="st">'Unix'</span>].values[<span class="dv">0</span>]</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a><span class="co"># because of how this is set up index is also valid</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> lookup_date.loc[(lookup_date.Year <span class="op">==</span> year), <span class="st">'Unix'</span>].agg([<span class="st">'min'</span>, <span class="st">'max'</span>])</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>_[<span class="st">'min'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-121" class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> (</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>    (Result_lookup[<span class="st">'Date'</span>] <span class="op">&gt;=</span> _[<span class="st">'min'</span>]) <span class="op">&amp;</span> </span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>    (Result_lookup[<span class="st">'Date'</span>] <span class="op">&lt;=</span> _[<span class="st">'max'</span>]) <span class="op">&amp;</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>    (Result_lookup[<span class="st">'FactorialUID'</span>] <span class="op">==</span> lookup[<span class="st">'FactorialUID'</span>])</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>idx_Result <span class="op">=</span> Result_lookup.loc[mask, ].index</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>Result[idx_Result, ].shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-122" class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co">#TODO make sure there aren't any values before the SowDate</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>Result_list</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-123" class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>start <span class="op">=</span> <span class="dv">129486</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>px.imshow((Result[(start<span class="op">-</span><span class="dv">30</span>):(start<span class="op">+</span><span class="dv">30</span>), <span class="dv">1</span>:<span class="op">-</span><span class="dv">1</span>].numpy()[<span class="dv">0</span>:<span class="dv">30</span>, ]).transpose())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-124" class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>px.imshow(Result[idx_Result, ].numpy()[<span class="dv">0</span>:<span class="dv">30</span>, ])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-125" class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>out <span class="op">=</span> torch.zeros((<span class="dv">365</span>, <span class="dv">6</span>))</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>Result_lookup.loc[mask, [<span class="st">'Date'</span>]].<span class="bu">min</span>().values[<span class="dv">0</span>] <span class="op">-</span> _[<span class="st">'min'</span>]</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a><span class="co"># sow_date - _['min']</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-126" class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>datetime.datetime(<span class="dv">1970</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>) <span class="op">+</span> datetime.timedelta(<span class="dv">10957</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-127" class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># idx_Result.to_list()</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Result</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-128" class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>Genotypes_cols</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/DanielKick-USDA\.github\.io\/apsimxml");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/DanielKick-USDA/apsimxml/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>